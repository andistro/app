#!/bin/bash

if [ -f "$PREFIX/var/lib/andistro/lib/share/global" ]; then
    chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
    source "$PREFIX/var/lib/andistro/lib/share/global"
elif [ -f "/usr/local/lib/andistro/global" ]; then
    chmod +x "/usr/local/lib/andistro/global"
    source "/usr/local/lib/andistro/global"
else
    echo ""
fi

# Template de verificação do sistema operacional
# if echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
#   echo "Executando comando para Debian/Ubuntu"
# elif echo "$inxi_out" | grep -q 'Distro:.*Android'; then
#   echo "Executando comando para Android"
# else
#   echo "Sistema não identificado"
# fi

# if echo "$inxi_out" | grep -q 'Distro:.*Android'; then

# elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then

# else
#   echo "Sistema não identificado"
# fi
if grep -q "^# hide-soft-keyboard-on-startup = true"  ~/.termux/termux.properties; then
    # Descomenta a linha removendo o '#' no começo
    sed -i "s/^# hide-soft-keyboard-on-startup = true/hide-soft-keyboard-on-startup = true/"  ~/.termux/termux.properties
    termux-reload-settings
fi

# Adiciona a configuração de teclas extras se não estiver presente
if ! grep -Fq "extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]" ~/.termux/termux.properties; then
    # Aplica os sed
    sed -i "s|^# *extra-keys = \[\['ESC','/','-','HOME','UP','END','PGUP'\], \\\\|extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]|" ~/.termux/termux.properties
    sed -i "s|^#[[:space:]]*\['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN']]||" ~/.termux/termux.properties

    # Recarrega Termux settings
    termux-reload-settings
fi

# Log de erros
if [ ! -d "/sdcard/termux/andistro/logs" ];then
    mkdir -p "/sdcard/termux/"
    mkdir -p "/sdcard/termux/andistro"
    mkdir -p "/sdcard/termux/andistro/distros"
    mkdir -p "/sdcard/termux/andistro/logs"
    touch "/sdcard/termux/andistro/logs/.nomedia"
fi
andistro_files="$PREFIX/var/lib/andistro"
ANDISTRO_LOG="/sdcard/termux/andistro/logs"

#=============================================================================================
# COMANDOS
#=============================================================================================
if [ -z "$1" ]; then
    if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
        HEIGHT=0
        WIDTH=100
        CHOICE_HEIGHT=5
        export PORT=1

        if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
            OPTIONS=(s "$label_system_start"
                    d "$label_system_uninstall"
                    i "$label_system_install_other_systems"
                    u "$label_andistro_updater"
                    t "$label_andistro_termianl_viewer")
        else
            OPTIONS=(i "$label_system_install_systems"
                    u "$label_andistro_updater"
                    t "$label_andistro_termianl_viewer")
        fi

        CHOICE=$(dialog --no-shadow --clear \
            --title "AnDistro" \
            --menu "$label_choose_one_of_the_option:" \
            $HEIGHT $WIDTH $CHOICE_HEIGHT \
            "${OPTIONS[@]}" \
            2>&1 >/dev/tty)
        clear
        case $CHOICE in
            i)
                OPTIONS=(d "Debian"
                        u "Ubuntu"
                        t "$label_andistro_termianl_viewer")

                CHOICE=$(dialog --no-shadow --clear \
                    --title "AnDistro" \
                    --menu "$label_choose_one_of_the_option:" \
                    $HEIGHT $WIDTH $CHOICE_HEIGHT \
                    "${OPTIONS[@]}" \
                    2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro  -i debian
                        ;;
                    u)
                        andistro -i ubuntu
                        ;;
                    t)
                        andistro -i
                        ;;
                esac
            ;;
            s)
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi

                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi

                if $start_debian && ! $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            t "$label_andistro_termianl_viewer")
                elif ! $start_debian && $start_ubuntu; then
                    OPTIONS=(u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                elif $start_debian && $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                else
                    # Não tem nenhum sistema instalado
                    OPTIONS=(. " ")
                fi

                CHOICE=$(dialog --no-shadow --clear \
                    --title "AnDistro" \
                    --menu "$label_choose_one_of_the_option:" \
                    $HEIGHT $WIDTH $CHOICE_HEIGHT \
                    "${OPTIONS[@]}" \
                    2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro -s debian
                        ;;
                    u)
                        andistro -s ubuntu
                        ;;
                    t)
                        andistro -s
                        ;;
                esac
            ;;
            u)
                andistro -u
                andistro
            ;;
            d)
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi

                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi

                if $start_debian && ! $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            t "$label_andistro_termianl_viewer")
                elif ! $start_debian && $start_ubuntu; then
                    OPTIONS=(u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                elif $start_debian && $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                else
                    # Não tem nenhum sistema instalado
                    OPTIONS=(. " ")

                fi

                CHOICE=$(dialog --no-shadow --clear \
                    --title "AnDistro" \
                    --menu "$label_choose_one_of_the_option:" \
                    $HEIGHT $WIDTH $CHOICE_HEIGHT \
                    "${OPTIONS[@]}" \
                    2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro -d debian
                        
                        ;;
                    u)
                        andistro -d ubuntu
                        ;;
                    t)
                        andistro -d
                        ;;
                esac
            ;;
            t)
                andistro terminal
            ;;
        esac
    elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
        echo "$label_command_not_available"
        echo " "
        echo "$distro_desc_line_1"
        echo " "
        echo "$distro_desc_line_10"
        echo "$distro_desc_line_17"
        echo " "
        echo "$distro_desc_line_18"
        echo "$distro_desc_line_19"
        echo " "
        echo "$distro_desc_line_20"
        echo "$distro_desc_line_21"
        echo "$distro_desc_line_22"
        echo "$distro_desc_line_23"
        echo " "
        echo "$distro_desc_line_24"
        echo "$distro_desc_line_25"
        echo "$distro_desc_line_26"
        echo "$distro_desc_line_27"
        echo "$distro_desc_line_28"
        echo " "
        echo "$distro_desc_line_29"
        echo "$distro_desc_line_30"

    else
        echo "$label_system_not_found"
    fi
exit 0
fi

case "$1" in
    -u)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            echo -e "\n$distro_wait"
            update_progress() {
                current_step=$1
                total_steps=$2

                percent=$((current_step * 100 / total_steps))
                bar_length=30
                filled_length=$((percent * bar_length / 100))
                empty_length=$((bar_length - filled_length))

                filled_bar=$(printf "%${filled_length}s" | tr " " "=")
                empty_bar=$(printf "%${empty_length}s" | tr " " " ")

                printf "\r[%s%s] %3d%%" "$filled_bar" "$empty_bar" "$percent" > /dev/tty
            }

            total_steps=26  # Número total de etapas que você quer monitorar
            current_step=0

            {
                #1 Atualiza os repositórios
                sleep 1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #2 Atualiza os repositórios
                pkg update > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #3 Instala o bash
                pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" bash -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #4 Instala o openssl
                pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" openssl -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #5 Instala o apt
                pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" apt -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #6 Atualiza os pacotes
                pkg upgrade -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #7 Verifica se o termux-exec está instalado
                if ! dpkg -l | grep -qw termux-exec; then
                    pkg install --no-install-recommends termux-exec -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #8 Verifica se o proot está instalado
                if ! dpkg -l | grep -qw proot; then
                    pkg install --no-install-recommends proot -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #9 Verifica se o x11-repo está instalado
                if ! dpkg -l | grep -qw x11-repo; then
                    pkg install --no-install-recommends x11-repo -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #10 Verifica se o termux-x11-nightly está instalado
                if ! dpkg -l | grep -qw termux-x11-nightly; then
                    pkg install --no-install-recommends termux-x11-nightly -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #11 Verifica se o pulseaudio está instalado
                if ! dpkg -l | grep -qw pulseaudio; then
                    pkg install --no-install-recommends pulseaudio -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #12 Verifica se o wget está instalado
                if ! dpkg -l | grep -qw wget; then
                    pkg install --no-install-recommends wget -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #13 Verifica se o dialog está instalado
                if ! dpkg -l | grep -qw dialog; then
                    pkg install --no-install-recommends dialog -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #14 Verifica se o tar está instalado
                if ! dpkg -l | grep -qw tar; then
                    pkg install --no-install-recommends tar -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #15 Verifica se o curl está instalado
                if ! dpkg -l | grep -qw curl; then
                    pkg install --no-install-recommends curl -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #16 Verifica se o unzip está instalado
                if ! dpkg -l | grep -qw unzip; then
                    pkg install --no-install-recommends unzip -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #17 Verifica se o xz-utils está instalado
                if ! dpkg -l | grep -qw xz-utils; then
                    pkg install --no-install-recommends xz-utils -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #18 Verifica se o debootstrap está instalado
                if ! dpkg -l | grep -qw debootstrap; then
                    pkg install --no-install-recommends debootstrap -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #19 Verifica se o dbus está instalado
                if ! dpkg -l | grep -qw dbus; then
                    pkg install --no-install-recommends dbus -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #20 Verifica se o pv está instalado
                if ! dpkg -l | grep -qw pv; then
                    pkg install --no-install-recommends pv -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #21 Verifica se o git está instalado
                if ! dpkg -l | grep -qw git; then
                    pkg install --no-install-recommends git -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #22 Verifica se o inxi está instalado
                if ! dpkg -l | grep -qw inxi; then
                    pkg install --no-install-recommends inxi -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #23 Verifica se o rsync está instalado
                if ! dpkg -l | grep -qw rsync; then
                    pkg install --no-install-recommends rsync -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #24 Todo o pacote de instalação
                git clone -b alpha https://github.com/andistro/app.git app-andistro_setup  > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #25 Extrai o pacote de instalação
                rm -rf "$HOME/app-andistro_setup/.git"
                rm -rf "$HOME/app-andistro_setup/andistro_setup"
                rm -rf "$HOME/app-andistro_setup/README.md"
                rm -rf "$HOME/app-andistro_setup/termos.sh"
                mv -f "$HOME/app-andistro_setup/andistro" "$PREFIX/bin/andistro"
                rsync -a "$HOME/app-andistro_setup/" "$PREFIX/var/lib/andistro/"
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #26 Mover o Andistro
                chmod +x "$PREFIX/bin/andistro"
                chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                echo
            }
            rm -rf "$HOME/app-andistro_setup"
            rm -rf andistro_setup.zip
            rm -rf "$HOME/andistro_setup"
            
            chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
            source "$PREFIX/var/lib/andistro/lib/share/global"
            echo -e "$label_update_finish"
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
        echo "$label_system_not_found"
        fi
        ;;

    -i)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if [ -z "$2" ]; then
                if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                    #Existe pelo menos um arquivo start-*
                    echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                    echo ""
                    echo "$distro_desc_line_6" #Exemplo de comando que permite a instalação:
                    echo "$distro_desc_line_7" #andistro -i debian
                    echo " "
                    echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                    echo "$distro_desc_line_9" #   andistro -u
                    echo " "
                    echo "$distro_desc_line_10" #Comandos disponíveis para você:
                    echo "$distro_desc_line_13" #    -i  instala a opção escolhida.
                    echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                    echo "   debian"
                    echo "   ubuntu"
                    echo " "
                    echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                    start_debian=false
                    start_ubuntu=false
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                        start_debian=true
                    fi
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                        start_ubuntu=true
                    fi
                    if $start_debian && ! $start_ubuntu; then
                        echo "   ubuntu" #se já existe o start-debian, mostra apenas o ubuntu
                        elif ! $start_debian && $start_ubuntu; then
                            echo "   debian" #se já existe o start-ubuntu, mostra apenas o debian
                        elif $start_debian && $start_ubuntu; then
                            echo "$label_all_systems_have_been_installed"
                            #sed -i '\|elif $start_debian && $start_ubuntu; then|a echo "para atualizar"' $PREFIX/bin/andistro

                        else
                            echo "   debian"
                            echo "   ubuntu"
                    fi
                else
                # Não existe nenhum arquivo start-*
                echo "$label_andistro_there_no_system_installed"
                fi
                exit 1
            fi
        
            if [ "$2" == "debian" ]; then
                distro_name="debian"
                distro_version="stable"
                distro_based="debian"
                distro_file="install-$distro_name.sh"
            elif ["$2" == "debian-sh"]; then
                distro_name="debian"
                distro_version="stable"
                distro_based="debian"
                distro_file=".terminal_mode/install-$distro_name.sh"
            elif [ "$2" == "ubuntu" ]; then
                distro_name="ubuntu"
                distro_version="noble"
                distro_based="debian"
                distro_file="install-$distro_name.sh"
            elif ["$2" == "ubuntu-sh"]; then
                distro_name="ubuntu"
                distro_version="noble"
                distro_based="debian"
                distro_file=".terminal_mode/install-$distro_name.sh"
            else
                echo "$distro_command_not_found: $2"
                exit 1
            fi

            echo "$distro_wait"
            config_file="$andistro_files/boot/.config/$distro_based-based"
            bin="$andistro_files/boot/start-$distro_name"
            folder="$andistro_files/boot/$distro_name/$distro_version"
            binds="$andistro_files/boot/$distro_name/binds"
            mkdir -p "$PREFIX/var/lib/andistro/boot/$distro_name"

            if [ ! -d "/sdcard/termux/andistro/boot/$distro_name/$distro_version" ];then
                mkdir -p "/sdcard/termux/"
                mkdir -p "/sdcard/termux/andistro"
                mkdir -p "/sdcard/termux/andistro/boot"
                mkdir -p "/sdcard/termux/andistro/boot/$distro_name/$distro_version"
            fi
            
            mkdir -p $binds
            andistro alerta timezone
            
            if [[ -n "${LANG_CODES[$system_icu_locale_code]}" ]]; then
                system_lang_code="$system_icu_locale_code"
            else
                system_lang_code="en-US"
            fi

            # Montar opções do menu
            OPTIONS=()
            OPTIONS+=("auto" "→ ${LANG_CODES[$system_lang_code]} $label_detected")
            OPTIONS+=("SEP" "────────────")  # Separador visual seguro

            # Adicionar os demais idiomas em ordem alfabética (exceto o detectado)
            for code in $(printf "%s\n" "${!LANG_CODES[@]}" | sort); do
                [[ "$code" == "$system_lang_code" ]] && continue
                OPTIONS+=("$code" "${LANG_CODES[$code]}")
            done

            # Tamanho da janela do dialog
            HEIGHT=0
            WIDTH=100
            CHOICE_HEIGHT=10

            # Mostrar menu com redirecionamento seguro
            exec 3>&1
            CHOICE=$(dialog --no-shadow --clear \
                --title "$label_choose_language" \
                --menu "$label_choose_language" \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                "${OPTIONS[@]}" \
                2>&1 1>&3)
                exec 3>&-

            # Determinar idioma selecionado
            if [[ "$CHOICE" == "auto" || -z "$CHOICE" ]]; then
                default_locale_system="$system_lang_code"
            elif [[ "$CHOICE" == "SEP" ]]; then
                exit 0  # ignorar separador
            else
                default_locale_system="$CHOICE"
            fi

            # Converter de pt-BR para pt_BR
            default_locale_env="${default_locale_system//-/_}"
            # Exportar, se necessário
            export default_locale_system
            export default_locale_env
            case `dpkg --print-architecture` in
                aarch64)
                    archurl="arm64" ;;
                arm)
                    archurl="armhf" ;;
                x86_x86)
                    archurl="amd64" ;;
                x86)
                    archurl="i386" ;;
                *)
                    echo "unknown architecture"; exit 1 ;;
            esac

            OPTIONS=(1 "${label_environments_select_default} (XFCE4)"
                    2 "${label_environments_select_light} (LXDE)"
                    3 "${label_environments_select_null}") 

            CHOICE=$(dialog --no-shadow --clear \
                        --title "$TITLE" \
                        --menu "$label_environments_select" \
                        $HEIGHT $WIDTH $CHOICE_HEIGHT \
                        "${OPTIONS[@]}" \
                        2>&1 >/dev/tty)
            case $CHOICE in
                1)	
                    # XFCE
                    config_environment="xfce4"
                
                    ;;
                2)	
                    # LXDE
                    config_environment="lxde"
                ;;
                3)
                    # Nenhum escolhido
                    rm -rf "$folder/root/system-config.sh"
                ;;
            esac
            OPTIONS=(1 "${label_light}"
                    2 "${label_dark}")

            CHOICE=$(dialog --no-shadow --clear \
                            --title "$TITLE" \
                            --menu "$label_choose_theme" \
                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                            "${OPTIONS[@]}" \
                            2>&1 >/dev/tty)
            case $CHOICE in
                1)	
                    distro_theme="Light"
                ;;
                2)	
                    distro_theme="Dark"
                ;;
            esac
            bash $PREFIX/var/lib/andistro/boot/$distro_file "$config_file" "$andistro_files" "$distro_name" "$bin" "$folder" "$binds" "$default_locale_system" "$default_locale_env" "$archurl" "$config_environment" "$distro_theme" "$distro_version"
            clear

            # dialog --no-shadow --title "$label_dialog_display_menu_sugestion" --yesno "$label_dialog_display_menu_sugestion_desc" 10 60
            # resposta=$?
            
            # if [ $resposta -eq 0 ]; then
            #     # Usuário escolheu "Sim"
            #     # Substituir a linha com exec $command
            #     if grep -q '^exec \$command' "$bin"; then
            #         sed -i 's|^exec \$command.*|exec $command -c "/usr/local/bin/andistro --boot vnc --dialog-display; exec /bin/bash --login"|' "$bin"
            #         andistro alerta setup-apply
            #     else
            #         dialog --msgbox "Linha 'exec \$command' não encontrada no arquivo!" 10 60
            #     fi
            # else
            #     # Usuário escolheu "Não"
            #     andistro alerta dialog-display
            # fi
            # clear
            andistro alerta install-success
            andistro -s $distro_name
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    -d)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if [ -z "$2" ]; then
                if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                    #Existe pelo menos um arquivo start-*
                    echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                    echo ""
                    echo "$distro_desc_line_2" #Exemplo de comando que permite a inicialização:
                    echo "$distro_desc_line_3" #andistro -s debian
                    echo " "
                    echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                    echo "$distro_desc_line_9" #   andistro -u
                    echo " "
                    echo "$distro_desc_line_10" #Comandos disponíveis para você:
                    echo "$distro_desc_line_11" #    -s  inicia a opção escolhida.
                    echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                    echo "   debian"
                    echo "   ubuntu"
                    echo " "
                    echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                    start_debian=false
                    start_ubuntu=false
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                        start_debian=true
                    fi
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                        start_ubuntu=true
                    fi
                    if $start_debian && ! $start_ubuntu; then
                        echo "   debian"
                    elif ! $start_debian && $start_ubuntu; then
                        echo "   ubuntu"
                    elif $start_debian && $start_ubuntu; then
                        echo "   debian"
                        echo "   ubuntu"
                    else
                        echo " "
                    fi
                    else
                        # Não existe nenhum arquivo start-*
                        echo "$label_andistro_there_no_system_installed"
                fi
                exit 1
            fi

            if [ "$2" == "total" ]; then
                # Desinstalação total
                echo "$distro_wait"
                rm -rf $andistro_files
                rm -rf $PREFIX/bin/andistro
                
                elif [ "$2" == "debian" ]; then
                    echo "$distro_wait"
                    distro_name="debian"

                elif [ "$2" == "ubuntu" ]; then
                    echo "$distro_wait"
                    distro_name="ubuntu"
                else
                    echo "$distro_command_not_found: $2"
                    exit 1
            fi
            rm -rf $andistro_files/boot/$distro_name
            rm -rf $andistro_files/boot/start-$distro_name
            andistro alerta uninstall-success
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    -s)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if [ -z "$2" ]; then
                if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                    #Existe pelo menos um arquivo start-*
                    echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                    echo ""
                    echo "$distro_desc_line_2" #Exemplo de comando que permite a inicialização:
                    echo "$distro_desc_line_3" #andistro -s debian
                    echo " "
                    echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                    echo "$distro_desc_line_9" #   andistro -u
                    echo " "
                    echo "$distro_desc_line_10" #Comandos disponíveis para você:
                    echo "$distro_desc_line_11" #    -s  inicia a opção escolhida.
                    echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                    echo "   debian"
                    echo "   ubuntu"
                    echo " "
                    echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                    start_debian=false
                    start_ubuntu=false
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                        start_debian=true
                    fi
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                        start_ubuntu=true
                    fi
                    if $start_debian && ! $start_ubuntu; then
                        echo "   debian"
                    elif ! $start_debian && $start_ubuntu; then
                        echo "   ubuntu"
                    elif $start_debian && $start_ubuntu; then
                        echo "   debian"
                        echo "   ubuntu"
                    else
                        echo " "
                    fi
                else
                # Não existe nenhum arquivo start-*
                echo "$label_andistro_there_no_system_installed"
                fi
            fi

            if [ "$2" == "debian" ]; then
                echo "$distro_wait"
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                bash $PREFIX/var/lib/andistro/boot/start-debian
                else
                echo "O Desbian ainda não foi instalado, siga os passos abaixo para a instalação:\n
                Digite o comando 'andistro' seguido do enter , escolha a opção instalar,"
                fi

            elif [ "$2" == "ubuntu" ]; then
                echo "$distro_wait"
                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                bash $PREFIX/var/lib/andistro/boot/start-ubuntu
                else
                echo "O arquivo não existe"
                fi
                

            else
                echo "$distro_command_not_found: $2"
                exit 1
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;

    -t|terminal)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                echo ""
                echo "$distro_desc_line_2" #Exemplo de comando que permite a inicialização:
                echo "$distro_desc_line_3" #andistro -s debian
                echo " "
                echo "$distro_desc_line_4" #Exemplo de comando que permite a desinstalação:
                echo "$distro_desc_line_5" #   andistro -d debian
                echo " "
                echo "$distro_desc_line_6" #Exemplo de comando que permite a instalação:
                echo "$distro_desc_line_7" #   andistro -i debian
                echo " "
                echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                echo "$distro_desc_line_9" #   andistro -u
                echo " "
                echo "$distro_desc_line_10" #Comandos disponíveis para você:
                echo "$distro_desc_line_11" #    -s  inicia a opção escolhida.
                echo "$distro_desc_line_12" #    -d  desinstala a opção escolhida.
                echo "$distro_desc_line_13" #    -i  instala a opção escolhida.
                echo "$distro_desc_line_14" #    -u  atualiza o AnDistro.
                echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                echo "   debian"
                echo "   ubuntu"
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi
                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi
                if $start_debian && ! $start_ubuntu; then
                    echo "   ubuntu"
                elif ! $start_debian && $start_ubuntu; then
                    echo "   debian"
                elif $start_debian && $start_ubuntu; then
                    echo -e "\u26A0 $label_all_systems_have_been_installed"
                else
                    echo "   debian"
                    echo "   ubuntu"
                fi
                echo " "
                echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi
                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi
                if $start_debian && ! $start_ubuntu; then
                    echo "   debian"
                elif ! $start_debian && $start_ubuntu; then
                    echo "   ubuntu"
                elif $start_debian && $start_ubuntu; then
                    echo "   debian"
                    echo "   ubuntu"
                else
                    echo " "
                fi
                echo " "
                echo "$distro_desc_line_31" #Modo de instalação sem interface gráfica, totalmente terminal
                echo "$distro_desc_line_32" #Adicione o -sh após o nome da distribuição
                echo "$distro_desc_line_33" #Exemplo de comando que permite a instalação sem interface gráfica
                echo "$distro_desc_line_34" #Modo de instalação sem interface gráfica, totalmente terminal
                echo "$distro_desc_line_35" #andistro -i debian-sh
                echo " "
                echo "$distro_desc_line_15"
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi
                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi
                if $start_debian && ! $start_ubuntu; then
                    echo "   ubuntu-sh"
                elif ! $start_debian && $start_ubuntu; then
                    echo "   debian-sh"
                elif $start_debian && $start_ubuntu; then
                    echo -e "\u26A0 $label_all_systems_have_been_installed"
                else
                    echo "   debian-sh"
                    echo "   ubuntu-sh"
                fi
                echo " "
            else
                echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                echo ""
                echo "$distro_desc_line_6" #Exemplo de comando que permite a instalação:
                echo "$distro_desc_line_7" #   andistro -i debian
                echo " "
                echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                echo "$distro_desc_line_9" #   andistro -u
                echo " "
                echo "$distro_desc_line_10" #Comandos disponíveis para você:
                echo "$distro_desc_line_13" #    -i  instala a opção escolhida.
                echo "$distro_desc_line_14" #    -u  atualiza o AnDistro.
                echo " "
                echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                echo "   debian"
                echo "   ubuntu"
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    # DevTools
    --setup)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$distro_command_not_found: $2"
            else
                case "$2" in
                    storage)
                        if [ -d "/sdcard" ]; then
                            if ls "/sdcard" &>/dev/null; then
                                # Acesso ao armazenamento OK!
                                echo "Acesso ao armazenamento."
                            else
                                # A pasta existe, mas sem permissão de acesso.
                                dialog --no-shadow --title "Permissão necessária" --ok-label "Permitir" \
                            --msgbox "Sem permissão de acesso." 10 60
                            rm -rf storage
                            termux-setup-storage
                            fi
                        else
                            termux-setup-storage
                        fi
                        ;;
                    battery)
                        dialog --no-shadow --title "Permissão necessária" --ok-label "Permitir" \
                            --msgbox "Após clicar em permitir, procure pelo Termux na lista de aplicativos, clique e escolha a opção não restrito." 10 60
                        am start -a android.settings.IGNORE_BATTERY_OPTIMIZATION_SETTINGS
                        ;;
                    termux-details-settings)
                        dialog --no-shadow --title "Informação" \
                            --msgbox "Após clicar em \"Ok\" será aberto a as informações do Termux no sistema." 10 60
                        am start -a android.settings.APPLICATION_DETAILS_SETTINGS -d "package:com.termux"
                        ;;
    
                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    --set-edit)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                nano "$PREFIX/bin/andistro"
            else
                case "$2" in
                    install-debian)
                        nano "$PREFIX/var/lib/andistro/boot/install-debian.sh"
                        ;;
                    start-debian)
                        nano "$PREFIX/var/lib/andistro/boot/start-debian"
                        ;;
                    install-ubuntu)
                        nano "$PREFIX/var/lib/andistro/boot/install-ubuntu.sh"
                        ;;
                    start-ubuntu)
                        nano "$PREFIX/var/lib/andistro/boot/start-ubuntu"
                        ;;
                    module-global)
                        nano "$PREFIX/var/lib/andistro/lib/share/global"
                        ;;
                    module-locale)
                        nano "$PREFIX/var/lib/andistro/lib/share/locales_${system_icu_locale_code}.sh"
                        ;;
                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    alerta)
        if [ -z "$2" ]; then
            # Não foi passado subcomando, comportamento padrão
            echo "$distro_command_not_found"
        else
            case "$2" in
                timezone)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "${label_distro_alert_timezone_desc} \n$label_distro_alert_timezone_detected $system_timezone\n\n$label_sleep_in_10s" 10 60
                    clear
                    ;;
                install-success)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "${label_install_success} \n\n$label_sleep_in_10s" 10 60
                    clear
                    ;;
                uninstall-success)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "${label_uninstall_success} \n\n$label_sleep_in_10s" 10 60
                    clear
                    ;;
                dialog-display)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "$label_start_dialog_display \n\n$label_sleep_in_10s" 10 60
                    clear
                    ;;
                setup-apply)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "$label_setup_apply \n\n$label_sleep_in_10s" 10 60
                    clear
                    ;;
                *)
                    echo "$distro_command_not_found: $2"
                    ;;
            esac
        fi
        ;;
    
    # Exclusivo para distribuições
    --boot)
        if echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            shift
            if [[ "$1" == "vnc" ]]; then
                shift 
                DISPLAY_VALUE=""
                PORT_VALUE=""
                SCALE_VALUE=""

                while [[ $# -gt 0 ]]; do
                    case "$1" in
                        --display)
                            DISPLAY_VALUE="$2"
                            #echo "Display set to $DISPLAY_VALUE"
                            shift 2
                            ;;
                        --scale)
                            SCALE_VALUE="$2"
                            #echo "Scale set to $SCALE_VALUE"
                            shift 2
                            ;;
                        --port)
                            PORT_VALUE="$2"
                            #echo "Port set to $PORT_VALUE"
                            shift 2
                            ;;
                        --kill)
                            # Buscar arquivos PID relacionados ao usuário
                            PID_FILES=$(ls -1 $HOME/.vnc/localhost:* 2>/dev/null)

                            # Verificar se há servidores ativos
                            if [ -z "$PID_FILES" ]; then
                                echo "$label_server_kill_desc_error"
                                exit 1
                            fi
                            # Extrair a porta do primeiro arquivo encontrado (ex: localhost:1.pid → 1)
                            PORTA=$(echo "$PID_FILES" | head -n1 | cut -d':' -f2 | cut -d'.' -f1)
                            echo "$label_server_kill_desc"
                            echo "$label_server_kill_desced: $PORTA"
                            # Parar o servidor VNC
                            vncserver -kill :$PORTA
                            # Remover arquivos temporários
                            rm -rf /tmp/.X$PORTA-lock
                            rm -rf /tmp/.X*-lock
                            rm -rf /tmp/.X11-unix/X$PORTA
                            rm -rf /tmp/.X11-unix/X*
                            shift
                            exit 1
                            ;;
                        --passwd)
                            while true; do # Loop até obter uma senha válida ou o usuário cancelar
                                PASSWORD=$(dialog --no-shadow --insecure --passwordbox "$label_password_input\n\n$label_keyboard_active_sugest" 10 50 3>&1 1>&2 2>&3)
                                if [ $? -eq 0 ]; then
                                    # Valida senha não vazia
                                    if [ -z "$PASSWORD" ]; then
                                        dialog --no-shadow --title "$label_error" --msgbox "$label_password_input_alert_important" 10 50
                                        continue
                                    fi
                                    break
                                else
                                    echo "${label_entry_canceled}"
                                    exit 1
                                fi

                            done

                            #Salvar a senha no arquivo apropriado
                            if ! /usr/bin/vncpasswd -f <<<"$PASSWORD"$'\n'"$PASSWORD" > "$HOME/.vnc/passwd"; then
                                dialog --no-shadow --title "$label_error" --msgbox "$label_password_save_failed" 10 50
                                exit 1
                            fi

                            # Proteger o arquivo com permissão segura
                            chmod 600 $HOME/.vnc/passwd

                            # Barra de progresso
                            {
                                for ((i = 0; i <= 100; i+=2)); do
                                    sleep 0.08
                                    echo $i
                                done
                            } | dialog --no-shadow --gauge "${label_change_password}" 10 50
                            shift
                            exit 1
                            ;;
                        --dialog-display)
                            timestamp=$(date +'%d%m%Y-%H%M%S')
                            andistro --boot vnc --kill # Para garantir que nenhum servidor VNC esteja rodando antes de iniciar um novo
                            #=====================================================================================
                            #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                            # Painel de seleção de resolução
                            #//////////////////////////////////////////////////////////////////////////////////////
                            #=====================================================================================
                            # Identificador de resolução repetida - Início
                            RESOLUTION_LOG="$HOME/.server_resolution_history"

                            # Criar arquivo de log se não existir
                            if [[ ! -f "$RESOLUTION_LOG" ]]; then
                                touch "$RESOLUTION_LOG"
                            fi

                            # Função para salvar resolução no histórico
                            save_resolution() {
                                local res="$1"
                                echo "$res|$(date +%s)" >> "$RESOLUTION_LOG"
                            }

                            # Função para verificar resoluções repetidas
                            check_repeated_resolution() {
                                local current_res="$1"
                                local count=0
                                local recent_count=0
                                local time_threshold=$(($(date +%s) - 604800)) # últimos 7 dias
                                
                                while IFS='|' read -r res timestamp; do
                                    if [[ "$res" == "$current_res" ]]; then
                                        ((count++))
                                        if [[ $timestamp -ge $time_threshold ]]; then
                                            ((recent_count++))
                                        fi
                                    fi
                                done < "$RESOLUTION_LOG"
                                
                                # Se foi usado 3+ vezes no total ou 2+ vezes na última semana
                                if [[ $count -ge 3 ]] || [[ $recent_count -ge 2 ]]; then
                                    return 0 # resolução repetida detectada
                                else
                                    return 1 # não é repetida o suficiente
                                fi
                            }

                            # Função para perguntar se quer definir como padrão
                            ask_set_default() {
                                local res="$1"
                                label_resolution_frequent_desc=$(eval echo -e "\"$label_resolution_frequent_desc\"" | sed "s/%s/$res/")

                                dialog --no-shadow --backtitle "$label_server_setup" \
                                    --title "$label_resolution_frequent" \
                                    --yesno "$label_resolution_frequent_desc" 10 60
                                return $?
                            }

                            # Função para salvar resolução padrão
                            save_default_resolution() {
                                local res="$1"
                                local port="$2"
                                local scale="$3"
                                echo "RESOLUTION=$res" > $HOME/.sever_resolution_default
                                echo "PORT=$port" >> $HOME/.sever_resolution_default
                                echo "SCALE=$scale" >> $HOME/.sever_resolution_default
                            }

                            # Verificar se existe resolução padrão
                            if [[ -f $HOME/.sever_resolution_default ]]; then
                                source $HOME/.sever_resolution_default
                                if [[ -n "$RESOLUTION" ]]; then
                                    dialog --no-shadow --backtitle "$label_server_setup" \
                                        --title "$label_resolution_option_default" \
                                        --yesno "$label_resolution_option_default_desc \n\n $label_resolution: $RESOLUTION \n$label_port: ${PORT:-1} \n$label_scale: ${SCALE:-1} \n\n$label_select_no_to_choose_other_resolution" 10 60
                                    if [[ $? -eq 0 ]]; then
                                        echo "$label_resolution_choose_default: $RESOLUTION"
                                        if [[ "$RESOLUTION" =~ ^([0-9]+)x([0-9]+)$ ]]; then
                                            andistro --boot vnc --display "$RESOLUTION" --port ${PORT:-1} --scale ${SCALE:-1}
                                            #bash --login
                                            exit 0
                                        fi
                                    else
                                        # Usuário optou por não usar o padrão - perguntar se quer remover
                                        dialog --no-shadow --backtitle "$label_server_setup" \
                                            --title "$label_resolution_remove_default" \
                                            --yesno "$label_resolution_remove_default_desc" 10 60
                                        if [[ $? -eq 0 ]]; then
                                            rm -f $HOME/.sever_resolution_default
                                            dialog --no-shadow --msgbox "$label_resolution_remove_default_sucess" 10 60
                                        fi
                                    fi
                                fi
                            fi

                            HEIGHT=0
                            WIDTH=0
                            CHOICE_HEIGHT=5
                            BACKTITLE="${label_select_resolution}"
                            TITLE="${label_select_resolution}"
                            MENU="${label_choose_one_resolution}"
                            export PORT=1

                            OPTIONS=(1 "${label_resolution_option_custom}"
                                    2 "${label_resolution_choose_options}")

                            CHOICE=$(dialog --no-shadow --no-shadow --clear \
                                            --backtitle "$BACKTITLE" \
                                            --title "$TITLE" \
                                            --menu "$MENU" \
                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                            "${OPTIONS[@]}" \
                                            2>&1 >/dev/tty)
                            clear

                            case $CHOICE in

                                1) 
                                    # Resolução manual
                                    while true; do
                                        RESOLUTION=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom \n $label_resolution_choose_custom_desc" 10 60 3>&1 1>&2 2>&3 3>&-)
                                        if [ $? -ne 0 ]; then
                                            andistro --boot vnc --display-panel
                                            exit 0
                                        fi
                                        if [ -n "$RESOLUTION" ]; then
                                            break
                                        else
                                            dialog --msgbox "$label_resolution_choose_custom_desc_alert" 10 60
                                        fi
                                    done

                                    while true; do
                                        PORT=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom_desc_port" 10 60 1 3>&1 1>&2 2>&3 3>&-)
                                        if [ $? -ne 0 ]; then
                                            andistro --boot vnc --display-panel
                                            exit 0
                                        fi
                                        # Aceita vazio ou valor, sem validação obrigatória, sai do loop
                                        # Define valor padrão 1 se vazio
                                        if [ -z "$PORT" ]; then
                                            PORT=1
                                        fi
                                        break
                                    done

                                    SCALE=""

                                    if pgrep -x "xfce4-session" > /dev/null; then
                                        while true; do
                                            SCALE=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom_desc_scale" 10 60 1 3>&1 1>&2 2>&3 3>&-)
                                            if [ $? -ne 0 ]; then
                                                andistro --boot vnc --display-panel
                                                exit 0
                                            fi
                                            # Pode validar o valor do scale aqui se quiser, ou aceitar vazio
                                            break
                                        done
                                    fi

                                    current_resolution="$RESOLUTION"
                                    save_resolution "$current_resolution"
                                    
                                    if check_repeated_resolution "$current_resolution"; then
                                        if ask_set_default "$current_resolution"; then
                                            save_default_resolution "$current_resolution" "$PORT" "$SCALE"
                                            echo "$label_resolution_option_custom ($current_resolution)" 10 50
                                        fi
                                    fi

                                    CMD="andistro --boot vnc --display $RESOLUTION --port $PORT"

                                    if [ -n "$SCALE" ]; then
                                        CMD="$CMD --scale $SCALE"
                                    fi

                                    $CMD

                                ;;
                                2)
                                    #Lista de resoluções
                                    OPTIONS=(1 "${label_landscape}"
                                            2 "${label_portrait}")

                                    CHOICE=$(dialog --no-shadow --clear \
                                            --backtitle "$BACKTITLE" \
                                            --title "$TITLE" \
                                            --menu "$MENU" \
                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                            "${OPTIONS[@]}" \
                                            2>&1 >/dev/tty)
                                    clear
                                    case $CHOICE in
                                        1)
                                            #Horizontal
                                            OPTIONS=(1 "${label_resolution_option_uwhd} (2560x1080)"
                                                    2 "${label_resolution_option_qdhd} (2560x1440)"
                                                    3 "${label_resolution_option_fhd} (1440x1080)"
                                                    4 "${label_resolution_option_fhd_wide} (1920x1080)"
                                                    5 "${label_resolution_option_hd} (1280x720)")

                                            CHOICE=$(dialog --no-shadow --clear \
                                                            --backtitle "$BACKTITLE" \
                                                            --title "$TITLE" \
                                                            --menu "$MENU" \
                                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                                            "${OPTIONS[@]}" \
                                                            2>&1 >/dev/tty)
                                            clear

                                            case $CHOICE in
                                                1)
                                                    #Ultrawide HD 
                                                    current_resolution="2560x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_uwhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                2)
                                                    #Quad-HD
                                                    current_resolution="2560x1440"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_qdhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                3)
                                                    #Full-HD
                                                    current_resolution="1440x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                4)
                                                    #Full-HD estendido
                                                    current_resolution="1920x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd_wide ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                5)
                                                    #HD
                                                    current_resolution="1280x720"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_hd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                            esac
                                        ;;
                                        2)
                                            #Vertical
                                            OPTIONS=(1 "${label_resolution_option_qdhd} (1440x2560)"
                                                    2 "${label_resolution_option_fhd} (1080x1440)"
                                                    3 "${label_resolution_option_hd} (1280x720)")

                                            CHOICE=$(dialog --no-shadow --clear \
                                                            --backtitle "$BACKTITLE" \
                                                            --title "$TITLE" \
                                                            --menu "$MENU" \
                                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                                            "${OPTIONS[@]}" \
                                                            2>&1 >/dev/tty)
                                            clear

                                            case $CHOICE in
                                                1)
                                                    #Quad-HD
                                                    current_resolution="1440x2560"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_qdhd_wide ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                2)
                                                    #Full-HD
                                                    current_resolution="1080x1440"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                3)
                                                    #HD
                                                    current_resolution="720x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd_wide ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                            esac

                                        ;;
                                    esac
                                ;;

                            esac
                            shift
                            exit 1
                            ;;
                        *)
                            echo "Comando ou parâmetro desconhecido: $1"
                            shift
                        ;;
                    esac
                done
                # Validar se a porta foi fornecida
                if [[ -z "$PORT_VALUE" ]]; then
                    PORT_VALUE="1"
                fi
                # Função para salvar resolução padrão             
                if [[ -n "$DISPLAY_VALUE" ]]; then
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop $DISPLAY_VALUE :$PORT_VALUE"
                    save_default_resolution() {
                        local res="$1"
                        local port="$2"
                        local scale="$3"
                        echo "RESOLUTION=$res" > $HOME/.sever_resolution_default
                        echo "PORT=$port" >> $HOME/.sever_resolution_default
                        echo "SCALE=$scale" >> $HOME/sever_resolution_default
                    }
                    current_resolution="$DISPLAY_VALUE"
                    save_resolution "$current_resolution"
                    
                    if check_repeated_resolution "$current_resolution"; then
                        if ask_set_default "$current_resolution"; then
                            if [ -n "$SCALE_VALUE" ]; then
                                save_default_resolution "$current_resolution" "$PORT_VALUE" "$SCALE_VALUE"
                            else
                                save_default_resolution "$current_resolution" "$PORT_VALUE" "1"
                            fi
                            
                            echo "$label_resolution_option_custom ($current_resolution)" 10 50
                        fi
                    fi
                    vncserver -localhost no -depth 24 -name andistro-desktop -geometry "$DISPLAY_VALUE" :$PORT_VALUE
                    #vncserver -localhost no -depth 24 -name remote-desktop -geometry "1920x1080" :1
                else
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop :$PORT_VALUE"
                    vncserver -localhost no -depth 24 -name andistro-desktop :"$PORT_VALUE"
                    #vncserver -localhost no -depth 24 -name remote-desktop :1
                fi
                # Verifica se o vncserver está rodando
                if pgrep -x "Xtigervnc" > /dev/null; then
                    # Se xfce4-session estiver rodando executa o comando de escala
                    if pgrep -x "xfce4-session" > /dev/null && [ -n "$SCALE_VALUE" ]; then
                        xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s "$SCALE_VALUE"
                    fi

                    echo -e "\n${label_server_start_desc} \n\n${label_user}: $USER\n${label_localhost} $HOSTNAME:$PORT / 120.0.0.1:$PORT / $wlan_ip_localhost:$PORT\n\n$label_password_forgot\n"
                else
                    echo "$label_server_start_error"
                fi
            fi
        elif echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            echo "$label_command_not_available"
        else
            echo "$label_system_not_found"  
        fi
        ;;

    # Erro
    *)
        echo "$distro_command_not_found $1"
        exit 1
        ;;
esac        

#!/bin/bash
# GITHUB Version
#inxi_out=$(inxi -F 2>/dev/null)

HEIGHT=0
WIDTH=100
CHOICE_HEIGHT=10
export PORT=1

#================================================================================================
if [ -n "$TERMUX_VERSION" ] || [ -n "$ANDROID_ROOT" ]; then  # Android

    # Carrega variáveis globais
    source "$PREFIX/var/lib/andistro/lib/share/global"

    # Configurações do Termux
    if grep -q "^# hide-soft-keyboard-on-startup = true"  ~/.termux/termux.properties; then
        # Descomenta a linha removendo o '#' no começo
        sed -i "s/^# hide-soft-keyboard-on-startup = true/hide-soft-keyboard-on-startup = true/"  ~/.termux/termux.properties
        termux-reload-settings
    fi
    # Adiciona a configuração de teclas extras se não estiver presente
    if ! grep -Fq "extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]" ~/.termux/termux.properties; then
        # Aplica os sed
        sed -i "s|^# *extra-keys = \[\['ESC','/','-','HOME','UP','END','PGUP'\], \\\\|extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]|" ~/.termux/termux.properties
        sed -i "s|^#[[:space:]]*\['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN']]||" ~/.termux/termux.properties

        # Recarrega Termux settings
        termux-reload-settings
    fi

    # Diretório do Andistro
    andistro_files="$PREFIX/var/lib/andistro"

    # Cria diretórios necessários no armazenamento
    if [ ! -d "/sdcard/termux/andistro/logs" ];then
        mkdir -p "/sdcard/termux/"
        mkdir -p "/sdcard/termux/andistro"
        mkdir -p "/sdcard/termux/andistro/manager"
        mkdir -p "/sdcard/termux/andistro/logs"
        touch "/sdcard/termux/andistro/logs/.nomedia"
    fi

#>>>#=============================================================================================
#>>># Menu principal do Andistro
    if [ -z "$1" ]; then
        if ls "$PREFIX/var/lib/andistro/manager/start-"* 1>/dev/null 2>&1; then
            OPTIONS=(s "$label_system_start" # Iniciar o sistema
                    d "$label_system_uninstall" # Desinstalar o sistema
                    i "$label_system_install_other_systems" # Instalar outros sistemas
                    u "$label_andistro_updater" # Atualizar o AnDistro
                    t "$label_andistro_termianl_viewer") # Ver como terminal
        else
            OPTIONS=(i "$label_system_install_systems" # Instalar sistemas
                    u "$label_andistro_updater" # Atualizar o AnDistro
                    t "$label_andistro_termianl_viewer") # Ver como terminal
        fi

        # Mostrar menu
        CHOICE=$(dialog --no-shadow --clear \
                        --title "AnDistro" \
                        --menu "$label_choose_one_of_the_option:" \
                        $HEIGHT $WIDTH $CHOICE_HEIGHT \
                        "${OPTIONS[@]}" \
                        2>&1 >/dev/tty)
        clear

        # Opções do menu
        case $CHOICE in
            # Iniciar o sistema
            s)
                start_debian=false
                start_ubuntu=false

                if [ -f "$PREFIX/var/lib/andistro/manager/start-debian" ]; then
                    start_debian=true
                fi

                if [ -f "$PREFIX/var/lib/andistro/manager/start-ubuntu" ]; then
                    start_ubuntu=true
                fi

                if $start_debian && ! $start_ubuntu; then
                    OPTIONS=(d "Debian")
                elif ! $start_debian && $start_ubuntu; then
                    OPTIONS=(u "Ubuntu")
                elif $start_debian && $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            u "Ubuntu")
                else
                # Não tem nenhum sistema instalado
                OPTIONS=(. "$label_back") # Voltar
                fi

                CHOICE=$(dialog --no-shadow --clear \
                                --title "AnDistro" \
                                --menu "$label_choose_one_of_the_option:" \
                                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                "${OPTIONS[@]}" \
                                2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro -s debian
                        ;;
                    u)
                        andistro -s ubuntu
                        ;;
                    .)
                        andistro
                        ;;
                esac
            ;;

            # Desinstalar o sistema
            d)
                start_debian=false
                start_ubuntu=false

                if [ -f "$PREFIX/var/lib/andistro/manager/start-debian" ]; then
                    start_debian=true
                fi

                if [ -f "$PREFIX/var/lib/andistro/manager/start-ubuntu" ]; then
                    start_ubuntu=true
                fi

                if $start_debian && ! $start_ubuntu; then
                    OPTIONS=(d "Debian")
                elif ! $start_debian && $start_ubuntu; then
                    OPTIONS=(u "Ubuntu")
                elif $start_debian && $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            u "Ubuntu")
                else
                # Não tem nenhum sistema instalado
                OPTIONS=(. "$label_back") # Voltar
                fi

                CHOICE=$(dialog --no-shadow --clear \
                                --title "AnDistro" \
                                --menu "$label_choose_one_of_the_option:" \
                                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                "${OPTIONS[@]}" \
                                2>&1 >/dev/tty)
                
                case $CHOICE in
                    d)
                        andistro -d debian
                        andistro
                        ;;
                    u)
                        andistro -d ubuntu
                        andistro
                        ;;
                    .)
                        andistro
                        ;;
                esac
            ;;

            # Instalar sistemas
            i)
                if ls "$PREFIX/var/lib/andistro/manager/start-debian" 1>/dev/null 2>&1; then
                    OPTIONS=(u "Ubuntu")
                elif ls "$PREFIX/var/lib/andistro/manager/start-ubuntu" 1>/dev/null 2>&1; then
                    OPTIONS=(d "Debian")
                else
                    OPTIONS=(d "Debian"
                            u "Ubuntu")
                fi

                CHOICE=$(dialog --no-shadow --clear \
                                --title "AnDistro" \
                                --menu "$label_choose_one_of_the_option:" \
                                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                "${OPTIONS[@]}" \
                                2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro -i debian
                        ;;
                    u)
                        andistro -i ubuntu
                        ;;
                esac
            ;;

            # Atualizar o AnDistro
            u)
                andistro -u dialog
                andistro
            ;;
        
            # Ver como terminal
            t)
                andistro terminal
            ;;
        esac
    exit 0
    fi

#>>>#=============================================================================================
#>>># Ações para funcionar no Termux

    case "$1" in
        # Comando para atualizar o Andistro
        -u)
            if [ -z "$2" ]; then
                echo -e "\n$distro_wait"
                update_progress() {
                    current_step=$1
                    total_steps=$2

                    percent=$((current_step * 100 / total_steps))
                    bar_length=30
                    filled_length=$((percent * bar_length / 100))
                    empty_length=$((bar_length - filled_length))

                    filled_bar=$(printf "%${filled_length}s" | tr " " "=")
                    empty_bar=$(printf "%${empty_length}s" | tr " " " ")

                    printf "\r[%s%s] %3d%%" "$filled_bar" "$empty_bar" "$percent" > /dev/tty
                }

                total_steps=26  # Número total de etapas que você quer monitorar
                current_step=0

                {
                    #1 Atualiza os repositórios
                    sleep 1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #2 Atualiza os repositórios
                    pkg update > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #3 Instala o bash
                    pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" bash -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #4 Instala o openssl
                    pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" openssl -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #5 Instala o apt
                    pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" apt -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #6 Atualiza os pacotes
                    pkg upgrade -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #7 Verifica se o termux-exec está instalado
                    if ! dpkg -l | grep -qw termux-exec; then
                        pkg install --no-install-recommends termux-exec -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #8 Verifica se o proot está instalado
                    if ! dpkg -l | grep -qw proot; then
                        pkg install --no-install-recommends proot -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #9 Verifica se o x11-repo está instalado
                    if ! dpkg -l | grep -qw x11-repo; then
                        pkg install --no-install-recommends x11-repo -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #10 Verifica se o termux-x11-nightly está instalado
                    if ! dpkg -l | grep -qw termux-x11-nightly; then
                        pkg install --no-install-recommends termux-x11-nightly -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #11 Verifica se o pulseaudio está instalado
                    if ! dpkg -l | grep -qw pulseaudio; then
                        pkg install --no-install-recommends pulseaudio -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #12 Verifica se o wget está instalado
                    if ! dpkg -l | grep -qw wget; then
                        pkg install --no-install-recommends wget -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #13 Verifica se o dialog está instalado
                    if ! dpkg -l | grep -qw dialog; then
                        pkg install --no-install-recommends dialog -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #14 Verifica se o tar está instalado
                    if ! dpkg -l | grep -qw tar; then
                        pkg install --no-install-recommends tar -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #15 Verifica se o curl está instalado
                    if ! dpkg -l | grep -qw curl; then
                        pkg install --no-install-recommends curl -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #16 Verifica se o unzip está instalado
                    if ! dpkg -l | grep -qw unzip; then
                        pkg install --no-install-recommends unzip -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #17 Verifica se o xz-utils está instalado
                    if ! dpkg -l | grep -qw xz-utils; then
                        pkg install --no-install-recommends xz-utils -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #18 Verifica se o debootstrap está instalado
                    if ! dpkg -l | grep -qw debootstrap; then
                        pkg install --no-install-recommends debootstrap -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #19 Verifica se o dbus está instalado
                    if ! dpkg -l | grep -qw dbus; then
                        pkg install --no-install-recommends dbus -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #20 Verifica se o pv está instalado
                    if ! dpkg -l | grep -qw pv; then
                        pkg install --no-install-recommends pv -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #21 Verifica se o git está instalado
                    if ! dpkg -l | grep -qw git; then
                        pkg install --no-install-recommends git -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #22 Verifica se o inxi está instalado
                    if ! dpkg -l | grep -qw inxi; then
                        pkg install --no-install-recommends inxi -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #23 Verifica se o rsync está instalado
                    if ! dpkg -l | grep -qw rsync; then
                        pkg install --no-install-recommends rsync -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #24 Todo o pacote de instalação
                    git clone --depth 1 -b alpha https://github.com/andistro/app.git app-andistro_setup  > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #25 Extrai o pacote de instalação
                    rm -rf "$HOME/app-andistro_setup/.git"
                    rm -rf "$HOME/app-andistro_setup/andistro_setup"
                    rm -rf "$HOME/app-andistro_setup/README.md"
                    rm -rf "$HOME/app-andistro_setup/.editconfig"
                    rm -rf "$HOME/app-andistro_setup/.gitignore"
                    rm -rf "$HOME/app-andistro_setup/.gitattributes"
                    rm -rf "$HOME/app-andistro_setup/termos.sh"
                    mv -f "$HOME/app-andistro_setup/andistro" "$PREFIX/bin/andistro"
                    rsync -a "$HOME/app-andistro_setup/" "$PREFIX/var/lib/andistro/"
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #26 Mover o Andistro
                    chmod +x "$PREFIX/bin/andistro"
                    chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    echo
                }
            elif [ "$2" == "dialog" ]; then
                show_progress_dialog steps-multi-label 38 \
                    "${label_progress}" 'sleep 1' \
                    "${label_find_update}" 'pkg update' \
                    "${label_find_update}" 'pkg install --no-install-recommends --option=Dpkg::Options::="--force-confnew" bash -y' \
                    "${label_find_update}" 'pkg install --no-install-recommends --option=Dpkg::Options::="--force-confnew" openssl -y' \
                    "${label_find_update}" 'pkg install --no-install-recommends --option=Dpkg::Options::="--force-confnew" apt -y' \
                    "${label_upgrade}" 'pkg upgrade' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends termux-exec -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends proot -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends x11-repo -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends termux-x11-nightly -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends pulseaudio -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends wget -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends dialog -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends tar -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends curl -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends unzip -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends xz-utils -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends debootstrap -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends dbus -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends pv -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends git -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends inxi -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends rsync -y' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup"' \
                    "${label_install_script_download}" 'git clone --depth 1 -b alpha https://github.com/andistro/app.git app-andistro_setup' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.git"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/andistro_setup"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/README.md"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.editconfig"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.gitignore"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.gitattributes"' \
                    "${label_install_script_download}" 'mv -f "$HOME/app-andistro_setup/andistro" "$PREFIX/bin/andistro"' \
                    "${label_install_script_download}" 'mv -f "$HOME/app-andistro_setup/termos.sh" "$HOME/termos.sh"' \
                    "${label_install_script_download}" 'rsync -a "$HOME/app-andistro_setup/" "$PREFIX/var/lib/andistro/"' \
                    "${label_install_script_download}" 'chmod +x "$PREFIX/bin/andistro"' \
                    "${label_install_script_download}" 'chmod +x "$PREFIX/var/lib/andistro/lib/share/global"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/storage"' \
                    "${label_install_script_download}" 'termux-setup-storage'
            else
                echo "$distro_command_not_found: $2"
                exit 1
            fi
            
            rm -rf "$HOME/app-andistro_setup"
            rm -rf "$HOME/termos.sh"
            rm -rf andistro_setup.zip
            rm -rf "$HOME/andistro_setup"
            
            chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
            source "$PREFIX/var/lib/andistro/lib/share/global"
            echo -e "$label_update_finish"
        ;;

        # Comando para instalar uma distro
        -i)
            if [ -z "$2" ]; then
                andistro terminal
            elif [ "$2" == "debian" ]; then
                distro_name="debian"
                distro_version="stable"
                distro_based="debian"
                distro_file="install-$distro_name.sh"

            elif ["$2" == "debian-sh"]; then
                distro_name="debian"
                distro_version="stable"
                distro_based="debian"
                distro_file=".terminal_mode/install-$distro_name.sh"

            elif [ "$2" == "ubuntu" ]; then
                distro_name="ubuntu"
                distro_version="noble"
                distro_based="debian"
                distro_file="install-$distro_name.sh"

            elif ["$2" == "ubuntu-sh"]; then
                distro_name="ubuntu"
                distro_version="noble"
                distro_based="debian"
                distro_file=".terminal_mode/install-$distro_name.sh"

            else
                echo "$distro_command_not_found: $2"
                exit 1
            fi

            echo "$distro_wait" # Aguarde

            config_file="$andistro_files/manager/.config/$distro_based-based"
            bin="$andistro_files/manager/start-$distro_name"
            folder="$andistro_files/manager/$distro_name/$distro_version"
            
            mkdir -p "$PREFIX/var/lib/andistro/manager/$distro_name"

            # Cria diretórios necessários no armazenamento
            if [ ! -d "/sdcard/termux/andistro/manager/$distro_name/$distro_version" ];then
                mkdir -p "/sdcard/termux/andistro/manager/$distro_name/$distro_version"
            fi
            
            # Menu de seleção de idioma
            if [[ -n "${LANG_CODES[$system_icu_locale_code]}" ]]; then
                system_lang_code="$system_icu_locale_code" # Usa o código de idioma ICU detectado
            else
                system_lang_code="en-US" # Padrão para inglês se não detectado
            fi
            # Montar opções do menu
            OPTIONS=()
            OPTIONS+=("auto" "→ ${LANG_CODES[$system_lang_code]} $label_detected")
            OPTIONS+=("SEP" "────────────")  # Separador visual seguro
            # Adicionar os demais idiomas em ordem alfabética (exceto o detectado)
            for code in $(printf "%s\n" "${!LANG_CODES[@]}" | sort); do
                [[ "$code" == "$system_lang_code" ]] && continue
                OPTIONS+=("$code" "${LANG_CODES[$code]}")
            done
            # Mostrar menu com redirecionamento seguro
            exec 3>&1
            CHOICE=$(dialog --no-shadow --clear \
                            --title "$label_choose_language" \
                            --menu "$label_choose_language" \
                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                            "${OPTIONS[@]}" \
                            2>&1 1>&3)
                            exec 3>&-

            # Determinar idioma selecionado
            if [[ "$CHOICE" == "auto" || -z "$CHOICE" ]]; then
                default_locale_system="$system_lang_code"
            elif [[ "$CHOICE" == "SEP" ]]; then
                exit 0  # ignorar separador
            else
                default_locale_system="$CHOICE"
            fi
            # Converter de lang-LANG para lang_LANG
            default_locale_env="${default_locale_system//-/_}"
            # Exportar, se necessário
            export default_locale_system
            export default_locale_env

            # Detectar arquitetura
            case `dpkg --print-architecture` in
                aarch64)
                    archurl="arm64"
                ;;
                arm)
                    archurl="armhf"
                ;;
                x86_64)
                    archurl="amd64"
                ;;
                x86)
                    archurl="i386"
                ;;
                *)
                    echo "unknown architecture"; exit 1
                ;;
            esac

            # Menu de Ambiente Gráfico
            OPTIONS=(1 "${label_environments_select_default} (XFCE4)" # Interface padrão
                    2 "${label_environments_select_light} (LXDE)" # Interface leve
                    3 "${label_environments_select_null}")  # Nenhuma interface gráfica
            CHOICE=$(dialog --no-shadow --clear \
                            --title "$TITLE" \
                            --menu "$label_environments_select" \
                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                            "${OPTIONS[@]}" \
                            2>&1 >/dev/tty)

            case $CHOICE in
                # Interface padrão - XFCE4
                1)
                    config_environment="xfce4"
                ;;

                # Interface leve - LXDE
                2)	
                    config_environment="lxde"
                ;;

                # Nenhuma interface gráfica - Null
                3)
                    config_environment="null"
                ;;
            esac

            # Menu de Tema
            OPTIONS=(1 "${label_light}" # Tema claro
                    2 "${label_dark}") # Tema escuro

            CHOICE=$(dialog --no-shadow --clear \
                            --title "$TITLE" \
                            --menu "$label_choose_theme" \
                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                            "${OPTIONS[@]}" \
                            2>&1 >/dev/tty)
            case $CHOICE in
                # Tema claro
                1)	
                    distro_theme="Light"
                ;;
                # Tema escuro
                2)	
                    distro_theme="Dark"
                ;;
            esac

            andistro alerta timezone

            bash $PREFIX/var/lib/andistro/manager/$distro_file "$config_file" "$andistro_files" "$distro_name" "$bin" "$folder" "$binds" "$default_locale_system" "$default_locale_env" "$archurl" "$config_environment" "$distro_theme" "$distro_version"
            clear
            #echo "andistro --boot vnc --dialog-display" >> $folder/root/.bashrc # Adiciona o comando para iniciar o VNC automaticamente ao iniciar a distro
            
            andistro -s $distro_name
        ;;

        # Comando para desinstalar uma distro
        -d)
            if [ -z "$2" ]; then
                andistro terminal
            elif [ "$2" == "total" ]; then
                # Desinstalação total
                echo "$distro_wait"
                rm -rf $andistro_files
                rm -rf $PREFIX/bin/andistro
                exit 1
            elif [ "$2" == "debian" ]; then
                distro_name_upper="Debian"
                label_dialog_uninstall_menu_desc=$(printf "$label_dialog_uninstall_menu_desc" "$distro_name_upper")
                dialog --no-shadow --title "$label_dialog_uninstall_menu" --yesno "$label_dialog_uninstall_menu_desc" 10 60
                resposta=$?
                
                if [ $resposta -eq 0 ]; then
                    # Usuário escolheu "Sim"
                    echo "$distro_wait"
                    distro_name="debian"
                    distro_name_upper="Debian"
                    label_uninstalling_system=$(printf "$label_uninstalling_system" "$distro_name_upper")
                else
                    # Usuário escolheu "Não"
                    label_uninstall_cancelled=$(printf "$label_uninstall_cancelled" "Debian")
                    andistro alerta uninstall-cancelled
                    exit 1
                fi


            elif [ "$2" == "ubuntu" ]; then
                distro_name_upper="Ubuntu"
                label_dialog_uninstall_menu_desc=$(printf "$label_dialog_uninstall_menu_desc" "$distro_name_upper")
                dialog --no-shadow --title "$label_dialog_uninstall_menu" --yesno "$label_dialog_uninstall_menu_desc" 10 60
                resposta=$?
                
                if [ $resposta -eq 0 ]; then
                    # Usuário escolheu "Sim"
                    echo "$distro_wait"
                    distro_name="ubuntu"
                    distro_name_upper="Ubuntu"
                    label_uninstalling_system=$(printf "$label_uninstalling_system" "$distro_name_upper")
                else
                    # Usuário escolheu "Não"
                    label_uninstall_cancelled=$(printf "$label_uninstall_cancelled" "Ubuntu")
                    andistro alerta uninstall-cancelled
                    exit 1
                fi
            else
                    echo "$distro_command_not_found: $2"
                    exit 1
            fi
            show_progress_dialog steps-one-label "${label_uninstalling_system}" 5 \
                "sleep 1" \
                "sleep 1" \
                "sleep 1" \
                "rm -rf $andistro_files/manager/$distro_name" \
                "rm -rf $andistro_files/manager/start-$distro_name"

            andistro alerta uninstall-success
        ;;

        # Comando para iniciar uma distro
        -s)
            if [ -z "$2" ]; then
                andistro terminal

            elif [ "$2" == "debian" ]; then
                echo "$distro_wait"
                if [ -f "$PREFIX/var/lib/andistro/manager/start-debian" ]; then
                    bash $PREFIX/var/lib/andistro/manager/start-debian
                else
                    label_distro_not_installed_desc=$(printf "$label_distro_not_installed_desc" "Debian")
                    echo -e "$label_distro_not_installed_desc"
                fi

            elif [ "$2" == "ubuntu" ]; then
                echo "$distro_wait"
                if [ -f "$PREFIX/var/lib/andistro/manager/start-ubuntu" ]; then
                    bash $PREFIX/var/lib/andistro/manager/start-ubuntu
                else
                    label_distro_not_installed_desc=$(printf "$label_distro_not_installed_desc" "Ubuntu")
                    echo -e "$label_distro_not_installed_desc"
                fi

            else
                echo "$distro_command_not_found: $2"
                exit 1
            fi
        ;;

        # Comando para ver os comandos como terminal
        -t|terminal)
            start_distro=false
            start_debian=false
            start_ubuntu=false
            
            if ls "$PREFIX/var/lib/andistro/manager/start-"* 1>/dev/null 2>&1; then # Verifica se alguma distro está instalada
                start_distro=true
            fi
            if [ -f "$PREFIX/var/lib/andistro/manager/start-debian" ]; then # Verifica se o Debian está instalado
                    start_debian=true
            fi
            if [ -f "$PREFIX/var/lib/andistro/manager/start-ubuntu" ]; then # Verifica se o Ubuntu está instalado
                start_ubuntu=true
            fi
            echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
            echo ""
            echo "$distro_desc_line_2" #Exemplo de comando que permite a inicialização:
            echo "$distro_desc_line_3" #andistro -s debian
            echo " "
            echo "$distro_desc_line_4" #Exemplo de comando que permite a desinstalação:
            echo "$distro_desc_line_5" #   andistro -d debian
            echo " "
            echo "$distro_desc_line_6" #Exemplo de comando que permite a instalação:
            echo "$distro_desc_line_7" #   andistro -i debian
            echo " "
            echo "$distro_desc_line_31" #Modo de instalação sem interface gráfica, totalmente terminal
            echo "$distro_desc_line_32" #Adicione o -sh após o nome da distribuição
            echo " "
            echo "$distro_desc_line_33" #Exemplo de comando que permite a instalação sem interface gráfica
            echo "$distro_desc_line_34" #Modo de instalação sem interface gráfica, totalmente terminal
            echo "$distro_desc_line_35" #andistro -i debian-sh
            echo " "
            echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
            echo "$distro_desc_line_9" #   andistro -u
            echo " "
            echo "$distro_desc_line_10" #Comandos disponíveis para você:
            echo "$distro_desc_line_14" #    -u  atualiza o AnDistro.
            if $start_distro; then # Verifica se alguma distro está instalada
                echo "$distro_desc_line_11" #    -s  inicia a opção escolhida.
                echo "$distro_desc_line_12" #    -d  desinstala a opção escolhida.
            fi
            if $start_distro; then # Verifica se nenhuma distro está instalada
                echo "$distro_desc_line_13" #    -i  instala a opção escolhida.
            fi
            echo " "
            echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
            if $start_debian && ! $start_ubuntu; then # Verifica se apenas o Debian está instalado
                echo "   ubuntu" # Se o Debian estiver instalado, mostra apenas o Ubuntu
                echo "   ubuntu-sh"
            elif ! $start_debian && $start_ubuntu; then # Verifica se apenas o Ubuntu está instalado
                echo "   debian" # Se o Ubuntu estiver instalado, mostra apenas o Debian
                echo "   debian-sh"
            elif $start_debian && $start_ubuntu; then # Verifica se ambos estão instalados
                echo -e "\u26A0 $label_all_systems_have_been_installed" # Se ambos estiverem instalados, mostra o aviso: Todos os sistemas foram instalados
            else # Se nenhum estiver instalado
                echo "   debian"
                echo "   debian-sh"
                echo "   ubuntu"
                echo "   ubuntu-sh"
            fi
            echo " "
            echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
            if $start_debian && ! $start_ubuntu; then # Verifica se apenas o Debian está instalado
                echo "   debian" # Se o Debian estiver instalado, mostra apenas o Debian
            elif ! $start_debian && $start_ubuntu; then # Verifica se apenas o Ubuntu está instalado
                echo "   ubuntu" # Se o Ubuntu estiver instalado, mostra apenas o Ubuntu
            elif $start_debian && $start_ubuntu; then # Verifica se ambos estão instalados
                # Se ambos estiverem instalados, mostra ambos
                echo "   debian"
                echo "   ubuntu"
                
            else # Se nenhum estiver instalado
                # Se nenhum estiver instalado, mostra o aviso
                echo -e "\u26A0 $label_andistro_there_no_system_installed" #Não tem nenhum sistema instalado
            fi
            echo " "
        ;;

        # DevTools

        # Comando para configurar permissões e outras opções do Termux
        --setup)
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$distro_command_not_found: $2"
            else
                case "$2" in
                    # Comando andistro --setup storage para configurar permissão de armazenamento
                    storage-permission)
                        TEST_DIR="/sdcard/termux"
                        PKG="com.termux"

                        while true; do
                            if mkdir -p "$TEST_DIR" 2>/dev/null; then
                                # Sucesso: tem acesso ao armazenamento
                                rmdir "$TEST_DIR" 2>/dev/null || true
                                clear
                                break   # segue o script normalmente
                            fi

                            # Falhou: provavelmente sem permissão de armazenamento
                            rm -rf "$HOME/storage"
                            termux-setup-storage &

                            dialog --no-shadow --clear \
                            --title "Permissão de armazenamento" \
                            --yes-label "Já permiti" \
                            --no-label "Não consegui" \
                            --yesno "Permitir que o AnDistro tenha acesso e possa gerenciar o armazenamento do celular.\n\nIsto permite que acesse fotos, vídeos, música, áudios e outros arquivos neste dispositivo." 12 70

                            resp=$?

                            if [ $resp -eq 0 ]; then
                                # Botão "Já permiti": tenta de novo no próximo loop
                                continue
                            else
                                # Botão "Não consegui": ajuda + intents
                                dialog --no-shadow --title "Ajuda com permissão" \
                                --ok-label "Abrir configs" \
                                --msgbox "Clique no botão \"Permitir acesso\" nas configurações para liberar o acesso ao armazenamento.\n\nDepois de permitir, volte ao Termux e pressione \"Já permiti\"." 12 70

                                # 1) Tela de gerenciamento de TODOS os arquivos para o Termux (Android 11+)
                                am start \
                                -a android.settings.MANAGE_APP_ALL_FILES_ACCESS_PERMISSION \
                                -d "package:${PKG}" >/dev/null 2>&1
                            fi
                        done
                    ;;

                    # Comando andistro --setup battery para configurar permissão de ignorar otimização de bateria
                    battery)
                        PKG="com.termux"
                        # Configurações de otimização de bateria
                        # 1) Explica o que fazer
                        dialog --no-shadow --title "Otimização de bateria" \
                        --ok-label "Abrir configurações" \
                        --msgbox "Para evitar que o sistema encerre o Termux/AnDistro em segundo plano, é recomendado retirar a otimização de bateria.\n\nNa próxima tela, procure pelo aplicativo Termux, abra-o e escolha o modo \"Sem restrições\" ou \"Não restrito\"." 14 70

                        # 2) Abre tela de detalhes do app (de lá o usuário acessa Bateria)
                        am start -a android.settings.IGNORE_BATTERY_OPTIMIZATION_SETTINGS >/dev/null 2>&1

                        # 3) Após o usuário voltar ao Termux, apenas confirma (ambos saem)
                        dialog --no-shadow --clear \
                        --title "Otimização de bateria" \
                        --yes-label "Já retirei" \
                        --no-label "Vou deixar para depois" \
                        --yesno "Você já ajustou a otimização de bateria do Termux para \"Sem restrições\" / \"Não restrito\"?\n\nTanto faz a opção escolhida, este passo será finalizado agora." 13 70
                    ;;

                    # Comando andistro --setup termux-details-settings para abrir as informações do Termux no sistema
                    termux-details-settings)
                        dialog --no-shadow --title "Informação" \
                            --msgbox "Após clicar em \"Ok\" será aberto a as informações do Termux no sistema." 10 60
                        am start -a android.settings.APPLICATION_DETAILS_SETTINGS -d "package:com.termux"
                    ;;

                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        ;;
        
        # Comando para editar scripts e módulos do Andistro
        --set-edit)
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                nano "$PREFIX/bin/andistro"
            else
                case "$2" in
                    install-debian)
                        nano "$PREFIX/var/lib/andistro/manager/install-debian.sh"
                        ;;
                    start-debian)
                        nano "$PREFIX/var/lib/andistro/manager/start-debian"
                        ;;
                    install-ubuntu)
                        nano "$PREFIX/var/lib/andistro/manager/install-ubuntu.sh"
                        ;;
                    start-ubuntu)
                        nano "$PREFIX/var/lib/andistro/manager/start-ubuntu"
                        ;;
                    module-global)
                        nano "$PREFIX/var/lib/andistro/lib/share/global"
                        ;;
                    module-locale)
                        nano "$PREFIX/var/lib/andistro/lib/share/locales_${system_icu_locale_code}.sh"
                        ;;
                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        ;;

        # Comando para exibir alertas do Andistro
        alerta)
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$distro_command_not_found"
            else
                case "$2" in
                    timezone)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_distro_alert_timezone_desc} \n$label_distro_alert_timezone_detected $system_timezone\n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    install-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_install_success} \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    uninstall-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_uninstall_success} \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    uninstall-canelled)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_uninstall_cancelled} \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    dialog-display)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_start_dialog_display \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    setup-apply)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_setup_apply \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    app-vnc-setup)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "Agora iremos configurar o aplicativo VNC. Tenha certeza de que o aplicativo AVNC está instalado, caso contrário, esta estapa falhará \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        ;;
        # Erro
        *)
            echo "$distro_command_not_found $1"
            exit 1
            ;;
    esac
   
#=================================================================================================
elif [ -r /etc/os-release ] && grep -Eq '^ID=(debian|ubuntu)' /etc/os-release; then # Debian/Ubuntu
    source "/usr/local/lib/andistro/global"
#>>>#=============================================================================================
#>>># Menu principal do Andistro
    if [ -z "$1" ]; then
        echo "$distro_desc_line_1" # Use: andistro <comando> <opção> para seja feito a tarefa desejada.
        echo " "
        echo "$distro_desc_line_10" # Comandos disponíveis:
        echo "$distro_desc_line_17" #     --boot  comando para iniciar alguma configuração.
        echo " "
        echo "$distro_desc_line_18" # Subcomandos do --boot
        echo "$distro_desc_line_19" #     vnc  para iniciar o servidor VNC
        echo " "
        echo "$distro_desc_line_20" # Subcomandos do --boot vnc
        echo "$distro_desc_line_21" #     --display  define a resolução da tela que será exibida
        echo "$distro_desc_line_22" #     --scale    define a escala da tela (1 ou 2)
        echo "$distro_desc_line_23" #     --port     define a porta usada pelo servidor.
        echo "$distro_desc_line_29" # O comando --scale só funciona no xfce4, caso use no lxde, o comando será ignorado
        echo "$distro_desc_line_30" # O comando --display e --port não são obrigatórios e caso não use o servidor será iniciado na resolução e porta padrão.
        echo " "
        echo "$distro_desc_line_24" # Exemplo de comando que permite a inicialização do servior vnc
        echo "$distro_desc_line_25" # Modo simples
        echo "$distro_desc_line_26" #   andistro --boot vnc
        echo "$distro_desc_line_27" # Modo completo
        echo "$distro_desc_line_28" #   andistro --boot vnc --display 1920x1080 --port 1 --scale 1
        echo " "
        exit 0
    fi

#>>>#=============================================================================================
#>>># Ações para funcionar nas distribuições Debian/Ubuntu

    case "$1" in
        # Comando para exibir alertas do Andistro
        alerta)
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$distro_command_not_found"
            else
                case "$2" in
                    timezone)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_distro_alert_timezone_desc} \n$label_distro_alert_timezone_detected $system_timezone\n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    install-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_install_success} \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    uninstall-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_uninstall_success} \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    dialog-display)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_start_dialog_display \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    setup-apply)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_setup_apply \n\n$label_sleep_in_10s" 10 60
                        clear
                        ;;
                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        ;;

        # Comando para criar ponte de comunicação entre Termux e Andistro
        --termux-cmd)
            shift  # remove o --termux-cmd
            local file="/termux/home/bridge"
            rm -f "$file" 2>/dev/null
            # junta todos os argumentos restantes em uma linha de comando
            printf "%s" "$*" > "$file"
        ;;
        # Comando para iniciar alguma configuração
        --boot)
            shift
            
            # Comando para iniciar o servidor VNC
            if [[ "$1" == "vnc" ]]; then
                shift 
                DISPLAY_VALUE=""
                PORT_VALUE=""
                SCALE_VALUE=""
                # Subcomandos do vnc
                while [[ $# -gt 0 ]]; do
                    case "$1" in
                        --display)
                            DISPLAY_VALUE="$2"
                            #echo "Display set to $DISPLAY_VALUE"
                            shift 2
                            ;;
                        --scale)
                            SCALE_VALUE="$2"
                            #echo "Scale set to $SCALE_VALUE"
                            shift 2
                            ;;
                        --port)
                            PORT_VALUE="$2"
                            #echo "Port set to $PORT_VALUE"
                            shift 2
                            ;;
                        --kill)
                            # Buscar arquivos PID relacionados ao usuário
                            PID_FILES=$(ls -1 $HOME/.vnc/localhost:* 2>/dev/null)

                            # Verificar se há servidores ativos
                            if [ -z "$PID_FILES" ]; then
                                echo "$label_server_kill_desc_error"
                                exit 1
                            fi
                            # Extrair a porta do primeiro arquivo encontrado (ex: localhost:1.pid → 1)
                            PORTA=$(echo "$PID_FILES" | head -n1 | cut -d':' -f2 | cut -d'.' -f1)
                            echo "$label_server_kill_desc"
                            echo "$label_server_kill_desced: $PORTA"
                            # Parar o servidor VNC
                            vncserver -kill :$PORTA
                            # Remover arquivos temporários
                            rm -rf /tmp/.X$PORTA-lock
                            rm -rf /tmp/.X*-lock
                            rm -rf /tmp/.X11-unix/X$PORTA
                            rm -rf /tmp/.X11-unix/X*
                            shift
                            exit 1
                            ;;
                        --passwd)
                            while true; do # Loop até obter uma senha válida ou o usuário cancelar
                                PASSWORD=$(dialog --no-shadow --insecure --passwordbox "$label_password_input\n\n$label_keyboard_active_sugest" 10 50 3>&1 1>&2 2>&3)
                                if [ $? -eq 0 ]; then
                                    # Valida senha não vazia
                                    if [ -z "$PASSWORD" ]; then
                                        dialog --no-shadow --title "$label_error" --msgbox "$label_password_input_alert_important" 10 50
                                        continue
                                    fi
                                    break
                                else
                                    echo "${label_entry_canceled}"
                                    exit 1
                                fi

                            done

                            #Salvar a senha no arquivo apropriado
                            if ! /usr/bin/vncpasswd -f <<<"$PASSWORD"$'\n'"$PASSWORD" > "$HOME/.vnc/passwd"; then
                                dialog --no-shadow --title "$label_error" --msgbox "$label_password_save_failed" 10 50
                                exit 1
                            fi

                            # Proteger o arquivo com permissão segura
                            chmod 600 $HOME/.vnc/passwd

                            # Barra de progresso
                            {
                                for ((i = 0; i <= 100; i+=2)); do
                                    sleep 0.08
                                    echo $i
                                done
                            } | dialog --no-shadow --gauge "${label_change_password}" 10 50
                            shift
                            exit 1
                            ;;
                        --dialog-display)
                            timestamp=$(date +'%d%m%Y-%H%M%S')
                            andistro --boot vnc --kill # Para garantir que nenhum servidor VNC esteja rodando antes de iniciar um novo
                            #=====================================================================================
                            #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                            # Painel de seleção de resolução
                            #//////////////////////////////////////////////////////////////////////////////////////
                            #=====================================================================================
                            # Identificador de resolução repetida - Início
                            RESOLUTION_LOG="$HOME/.server_resolution_history"

                            # Criar arquivo de log se não existir
                            if [[ ! -f "$RESOLUTION_LOG" ]]; then
                                touch "$RESOLUTION_LOG"
                            fi

                            # Função para salvar resolução no histórico
                            save_resolution() {
                                local res="$1"
                                echo "$res|$(date +%s)" >> "$RESOLUTION_LOG"
                            }

                            # Função para verificar resoluções repetidas
                            check_repeated_resolution() {
                                local current_res="$1"
                                local count=0
                                local recent_count=0
                                local time_threshold=$(($(date +%s) - 604800)) # últimos 7 dias
                                
                                while IFS='|' read -r res timestamp; do
                                    if [[ "$res" == "$current_res" ]]; then
                                        ((count++))
                                        if [[ $timestamp -ge $time_threshold ]]; then
                                            ((recent_count++))
                                        fi
                                    fi
                                done < "$RESOLUTION_LOG"
                                
                                # Se foi usado 3+ vezes no total ou 2+ vezes na última semana
                                if [[ $count -ge 3 ]] || [[ $recent_count -ge 2 ]]; then
                                    return 0 # resolução repetida detectada
                                else
                                    return 1 # não é repetida o suficiente
                                fi
                            }

                            # Função para perguntar se quer definir como padrão
                            ask_set_default() {
                                local res="$1"
                                label_resolution_frequent_desc=$(eval echo -e "\"$label_resolution_frequent_desc\"" | sed "s/%s/$res/")

                                dialog --no-shadow --backtitle "$label_server_setup" \
                                    --title "$label_resolution_frequent" \
                                    --yesno "$label_resolution_frequent_desc" 10 60
                                return $?
                            }

                            # Função para salvar resolução padrão
                            save_default_resolution() {
                                local res="$1"
                                local port="$2"
                                local scale="$3"
                                echo "RESOLUTION=$res" >> $HOME/.sever_resolution_default
                                echo "PORT=$port" >> $HOME/.sever_resolution_default
                                echo "SCALE=$scale" >> $HOME/.sever_resolution_default
                            }

                            # Verificar se existe resolução padrão
                            if [[ -f $HOME/.sever_resolution_default ]]; then
                                source $HOME/.sever_resolution_default

                                if [[ "$RESOLUTION" =~ ^([0-9]+)x([0-9]+)$ ]]; then
                                    andistro --boot vnc --display "$RESOLUTION" --port ${PORT:-1} --scale ${SCALE:-1}
                                    exit 0
                                fi
                            fi

                            HEIGHT=0
                            WIDTH=0
                            CHOICE_HEIGHT=5
                            BACKTITLE="${label_select_resolution}"
                            TITLE="${label_select_resolution}"
                            MENU="${label_choose_one_resolution}"
                            export PORT=1

                            OPTIONS=(1 "${label_resolution_option_custom}"
                                    2 "${label_resolution_choose_options}")

                            CHOICE=$(dialog --no-shadow --no-shadow --clear \
                                            --backtitle "$BACKTITLE" \
                                            --title "$TITLE" \
                                            --menu "$MENU" \
                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                            "${OPTIONS[@]}" \
                                            2>&1 >/dev/tty)
                            clear

                            case $CHOICE in

                                1) 
                                    # Resolução manual
                                    while true; do
                                        RESOLUTION=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom \n $label_resolution_choose_custom_desc" 10 60 3>&1 1>&2 2>&3 3>&-)
                                        if [ $? -ne 0 ]; then
                                            andistro --boot vnc --dialog-display
                                            exit 0
                                        fi
                                        if [ -n "$RESOLUTION" ]; then
                                            break
                                        else
                                            dialog --msgbox "$label_resolution_choose_custom_desc_alert" 10 60
                                        fi
                                    done

                                    while true; do
                                        PORT=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom_desc_port" 10 60 1 3>&1 1>&2 2>&3 3>&-)
                                        if [ $? -ne 0 ]; then
                                            andistro --boot vnc --dialog-display
                                            exit 0
                                        fi
                                        # Aceita vazio ou valor, sem validação obrigatória, sai do loop
                                        # Define valor padrão 1 se vazio
                                        if [ -z "$PORT" ]; then
                                            PORT=1
                                        fi
                                        break
                                    done

                                    SCALE=""

                                    if pgrep -x "xfce4-session" > /dev/null; then
                                        while true; do
                                            SCALE=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom_desc_scale" 10 60 1 3>&1 1>&2 2>&3 3>&-)
                                            if [ $? -ne 0 ]; then
                                                andistro --boot vnc --dialog-display
                                                exit 0
                                            fi
                                            # Pode validar o valor do scale aqui se quiser, ou aceitar vazio
                                            break
                                        done
                                    fi

                                    current_resolution="$RESOLUTION"
                                    save_resolution "$current_resolution"
                                    
                                    if check_repeated_resolution "$current_resolution"; then
                                        if ask_set_default "$current_resolution"; then
                                            save_default_resolution "$current_resolution" "$PORT" "$SCALE"
                                            echo "$label_resolution_option_custom ($current_resolution)" 10 50
                                        fi
                                    fi

                                    CMD="andistro --boot vnc --display $RESOLUTION --port $PORT"

                                    if [ -n "$SCALE" ]; then
                                        CMD="$CMD --scale $SCALE"
                                    fi

                                    $CMD

                                ;;
                                2)
                                    #Lista de resoluções
                                    OPTIONS=(1 "${label_landscape}"
                                            2 "${label_portrait}")

                                    CHOICE=$(dialog --no-shadow --clear \
                                            --backtitle "$BACKTITLE" \
                                            --title "$TITLE" \
                                            --menu "$MENU" \
                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                            "${OPTIONS[@]}" \
                                            2>&1 >/dev/tty)
                                    clear
                                    case $CHOICE in
                                        1)
                                            #Horizontal
                                            OPTIONS=(1 "${label_resolution_option_uwhd} (2560x1080)"
                                                    2 "${label_resolution_option_qdhd} (2560x1440)"
                                                    3 "${label_resolution_option_fhd} (1440x1080)"
                                                    4 "${label_resolution_option_fhd_wide} (1920x1080)"
                                                    5 "${label_resolution_option_hd} (1280x720)")

                                            CHOICE=$(dialog --no-shadow --clear \
                                                            --backtitle "$BACKTITLE" \
                                                            --title "$TITLE" \
                                                            --menu "$MENU" \
                                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                                            "${OPTIONS[@]}" \
                                                            2>&1 >/dev/tty)
                                            clear

                                            case $CHOICE in
                                                1)
                                                    #Ultrawide HD 
                                                    current_resolution="2560x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_uwhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                2)
                                                    #Quad-HD
                                                    current_resolution="2560x1440"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_qdhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                3)
                                                    #Full-HD
                                                    current_resolution="1440x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                4)
                                                    #Full-HD estendido
                                                    current_resolution="1920x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd_wide ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                5)
                                                    #HD
                                                    current_resolution="1280x720"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_hd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                            esac
                                        ;;
                                        2)
                                            #Vertical
                                            OPTIONS=(1 "${label_resolution_option_qdhd} (1440x2560)"
                                                    2 "${label_resolution_option_fhd} (1080x1440)"
                                                    3 "${label_resolution_option_hd} (1280x720)")

                                            CHOICE=$(dialog --no-shadow --clear \
                                                            --backtitle "$BACKTITLE" \
                                                            --title "$TITLE" \
                                                            --menu "$MENU" \
                                                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                                                            "${OPTIONS[@]}" \
                                                            2>&1 >/dev/tty)
                                            clear

                                            case $CHOICE in
                                                1)
                                                    #Quad-HD
                                                    current_resolution="1440x2560"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_qdhd_wide ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                2)
                                                    #Full-HD
                                                    current_resolution="1080x1440"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                3)
                                                    #HD
                                                    current_resolution="720x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd_wide ($current_resolution)" 10 50
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                            esac

                                        ;;
                                    esac
                                ;;

                            esac
                            shift
                            exit 1
                            ;;
                        *)
                            echo "Comando ou parâmetro desconhecido: $1"
                            shift
                        ;;
                    esac
                done

                # Validar se a porta foi fornecida
                if [[ -z "$PORT_VALUE" ]]; then
                    PORT_VALUE="1"
                fi

                # Função para salvar resolução padrão             
                if [[ -n "$DISPLAY_VALUE" ]]; then
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop $DISPLAY_VALUE :$PORT_VALUE"

                    vncserver -localhost no -depth 24 -name andistro-desktop -geometry "$DISPLAY_VALUE" :$PORT_VALUE
                    #vncserver -localhost no -depth 24 -name remote-desktop -geometry "1920x1080" :1
                else
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop :$PORT_VALUE"
                    vncserver -localhost no -depth 24 -name andistro-desktop :"$PORT_VALUE"
                    #vncserver -localhost no -depth 24 -name remote-desktop :1
                fi
                
                # Verifica se o vncserver está rodando
                if pgrep -x "Xtigervnc" > /dev/null; then
                    # Se xfce4-session estiver rodando executa o comando de escala
                    if pgrep -x "xfce4-session" > /dev/null && [ -n "$SCALE_VALUE" ]; then
                        xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s "$SCALE_VALUE"
                    fi

                    echo -e "\n${label_server_start_desc} \n\n\033[1;96m${label_user}:\033[0m $USER\n\033[1;96m${label_localhost}:\033[0m $HOSTNAME\033[1;33m:\033[0m$PORT \033[1;33m/\033[0m 120.0.0.1\033[1;33m:\033[0m$PORT \033[1;33m/\033[0m $wlan_ip_localhost\033[1;33m:\033[0m$PORT\n\n\033[1;35m${label_password_forgot}\033[0m\n\n\033[1;38;5;208m${label_server_kill_desc_help}\033[0m"
                    echo -e "\e[1;33mDeseja abrir o aplicativo AVNC?\nCaso sim, tecle ENTER (↲), caso contrário, tecle ESC ou CTRL+C para ignorar\e[0m"

                    trap 'echo -e "\n\e[1;32mQuestionário finalizado pelo usuário.\e[0m"; exit 0' INT

                    read -s -n1 tecla

                    if [[ -z "$tecla" || "$tecla" == $'\r' || "$tecla" == $'\n' ]]; then
                        echo -e "\n\e[1;32mAbrindo aVNC...\e[0m"
                        termux-cmd "am start -d 'vnc://localhost:1?ConnectionName=AnDistro&SaveConnection=true'"
                        exit 1
                    fi

                    if [[ "$tecla" == $'\x1b' ]]; then
                        echo -e "\n\e[1;32mQuestionário finalizado (ESC).\e[0m"
                        exit 1
                    fi

                    echo -e "\n\e[1;31mTecla inválida, questionário finalizado.\e[0m"
                    exit 1
                else
                    echo "$label_server_start_error"
                fi
            fi
        ;;
        
        # Erro
        *)
            echo "$distro_command_not_found $1"
            exit 1
        ;;
    esac
#=================================================================================================
else # Nenhum dos dois
    echo "Sistema não identificado"
fi
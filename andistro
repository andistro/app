#!/bin/bash
# GITHUB Version
#inxi_out=$(inxi -F 2>/dev/null)

#================================================================================================
if [ -n "$TERMUX_VERSION" ] || [ -n "$ANDROID_ROOT" ]; then  # Android

    # Carrega variáveis globais
    source "$PREFIX/var/lib/andistro/lib/share/global"

    # Configurações do Termux
    if grep -q "^# hide-soft-keyboard-on-startup = true"  ~/.termux/termux.properties; then
        # Descomenta a linha removendo o '#' no começo
        sed -i "s/^# hide-soft-keyboard-on-startup = true/hide-soft-keyboard-on-startup = true/"  ~/.termux/termux.properties
        termux-reload-settings
    fi
    # Adiciona a configuração de teclas extras se não estiver presente
    # if ! grep -Fq "extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]" ~/.termux/termux.properties; then
    #     # Aplica os sed
    #     sed -i "s|^# *extra-keys = \[\['ESC','/','-','HOME','UP','END','PGUP'\], \\\\|extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]|" ~/.termux/termux.properties
    #     sed -i "s|^#[[:space:]]*\['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN']]||" ~/.termux/termux.properties

    #     # Recarrega Termux settings
    #     termux-reload-settings
    # fi
    if ! grep -q "^# Andistro Extra keys$" ~/.termux/termux.properties 2>/dev/null; then
  cat << 'EOF' >> ~/.termux/termux.properties


#############################################################################
# Andistro Extra keys
#############################################################################
extra-keys = [['ESC','/','-','HOME','UP','END','PGUP'], \
              ['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN'], \
              ['DRAWER','DEL','BKSP','PASTE','','KEYBOARD','ENTER']]
    
EOF
fi
    # Diretório do Andistro
    andistro_files="$PREFIX/var/lib/andistro"

    # Cria diretórios necessários no armazenamento
    if [ ! -d "/sdcard/termux/andistro/logs" ];then
        mkdir -p "/sdcard/termux/"
        mkdir -p "/sdcard/termux/andistro"
        mkdir -p "/sdcard/termux/andistro/manager"
        mkdir -p "/sdcard/termux/andistro/logs"
        touch "/sdcard/termux/andistro/logs/.nomedia"
    fi

#>>>#=============================================================================================
#>>># Menu principal do Andistro
    if [ -z "$1" ]; then

        if ls "$PREFIX/var/lib/andistro/manager/start-"* 1>/dev/null 2>&1; then
            OPTIONS=(s "$label_andistro_start_system" # Iniciar o sistema
                    d "$label_andistro_uninstall_system" # Desinstalar o sistema
                    u "$label_andistro_updater" # Atualizar o AnDistro
                    c "$label_settings_and_help" # Configurações e Ajuda
                    )
        else
            OPTIONS=(i "$label_andistro_install_system" # Instalar o sistema
                    u "$label_andistro_updater" # Atualizar o AnDistro
                    c "$label_settings_and_help" # Configurações e Ajuda
                    )
        fi

        # Mostrar menu
        CHOICE=$(dialog --no-shadow --clear \
                        --title "AnDistro [alpha]" \
                        --menu "$label_choose_one_of_the_option:" \
                        $dialog_height $dialog_width $dialog_choice_height \
                        "${OPTIONS[@]}" \
                        2>&1 >/dev/tty)

        dialog_retorno=$?  # ← Captura código de retorno

        if [ $dialog_retorno -eq 1 ]; then
            clear  # ← Clear se cancelado
            cat /data/data/com.termux/files/usr/etc/motd # exibe a mensagem padrão do Termux
            echo -e "\n$label_andistro_start_command_info"
            exit 0
        fi

        clear

        # Opções do menu
        case $CHOICE in
            # Iniciar o sistema
            s)
               andistro -s
            ;;

            # Desinstalar o sistema
            d)
                andistro -d
                andistro
            ;;

            # Instalar sistemas
            i)
                andistro -i
            ;;

            # Atualizar o AnDistro
            u)
                andistro -u dialog
                andistro
            ;;
        
            # Configurações e Ajuda
            c)
                OPTIONS=(1 "$label_andistro_battery_optimization" 
                    2 "$label_andistro_signal9_error" 
                    3 "$label_andistro_install_avnc"
                    4 "$label_andistro_storage_permission_check"
                    5 "$label_autoboot_andistro"
                    6 "$label_disable_autoboot_andistro"
                    7 "$label_andistro_uninstall"
                    8 "$label_back"
                    )

                CHOICE=$(dialog --no-shadow --clear \
                        --title "AnDistro" \
                        --cancel-label "$label_back" \
                        --menu "$label_choose_one_of_the_option:" \
                        $dialog_height $dialog_width $dialog_choice_height \
                        "${OPTIONS[@]}" \
                        2>&1 >/dev/tty)

                dialog_retorno=$?  # ← Captura código de retorno
                if [ $dialog_retorno -eq 1 ]; then
                    clear # ← Clear se cancelado
                    andistro
                    exit 0
                fi

                clear

                case $CHOICE in

                1)
                    andistro --setup battery
                    andistro
                ;;

                2)
                    andistro --setup phantom-procs
                    andistro
                ;;

                3)
                    andistro --setup avnc
                    andistro
                ;;

                4)
                    andistro --setup storage-permission
                    andistro
                ;;
                5)
                    andistro --setup autoboot
                    andistro
                ;;
                6)
                    andistro --setup autoboot-disable
                    andistro
                ;;
                7)
                    andistro -d andistro
                ;;
                8)
                    andistro
                ;;
                esac
            ;;
        esac
    exit 0
    fi

#>>>#=============================================================================================
#>>># Ações para funcionar no Termux

    case "$1" in
        # Comando para atualizar o Andistro
        -u)
            if [ -z "$2" ]; then
                echo -e "\n$label_wait"
                update_progress() {
                    current_step=$1
                    total_steps=$2

                    percent=$((current_step * 100 / total_steps))
                    bar_length=30
                    filled_length=$((percent * bar_length / 100))
                    empty_length=$((bar_length - filled_length))

                    filled_bar=$(printf "%${filled_length}s" | tr " " "=")
                    empty_bar=$(printf "%${empty_length}s" | tr " " " ")

                    printf "\r[%s%s] %3d%%" "$filled_bar" "$empty_bar" "$percent" > /dev/tty
                }

                total_steps=28  # Número total de etapas que você quer monitorar
                current_step=0

                {
                    #1 Atualiza os repositórios
                    sleep 1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #2 Atualiza os repositórios
                    pkg update > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #3 Instala o bash
                    pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" bash -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #4 Instala o openssl
                    pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" openssl -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #5 Instala o apt
                    pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" apt -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #6 Atualiza os pacotes
                    pkg upgrade -y > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #7 Verifica se o termux-exec está instalado
                    if ! dpkg -l | grep -qw termux-exec; then
                        pkg install --no-install-recommends termux-exec -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #8 Verifica se o proot está instalado
                    if ! dpkg -l | grep -qw proot; then
                        pkg install --no-install-recommends proot -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #9 Verifica se o x11-repo está instalado
                    if ! dpkg -l | grep -qw x11-repo; then
                        pkg install --no-install-recommends x11-repo -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #10 Verifica se o termux-x11-nightly está instalado
                    if ! dpkg -l | grep -qw termux-x11-nightly; then
                        pkg install --no-install-recommends termux-x11-nightly -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #11 Verifica se o pulseaudio está instalado
                    if ! dpkg -l | grep -qw pulseaudio; then
                        pkg install --no-install-recommends pulseaudio -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #12 Verifica se o wget está instalado
                    if ! dpkg -l | grep -qw wget; then
                        pkg install --no-install-recommends wget -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #13 Verifica se o dialog está instalado
                    if ! dpkg -l | grep -qw dialog; then
                        pkg install --no-install-recommends dialog -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #14 Verifica se o tar está instalado
                    if ! dpkg -l | grep -qw tar; then
                        pkg install --no-install-recommends tar -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #15 Verifica se o curl está instalado
                    if ! dpkg -l | grep -qw curl; then
                        pkg install --no-install-recommends curl -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #16 Verifica se o unzip está instalado
                    if ! dpkg -l | grep -qw unzip; then
                        pkg install --no-install-recommends unzip -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #17 Verifica se o xz-utils está instalado
                    if ! dpkg -l | grep -qw xz-utils; then
                        pkg install --no-install-recommends xz-utils -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #18 Verifica se o debootstrap está instalado
                    if ! dpkg -l | grep -qw debootstrap; then
                        pkg install --no-install-recommends debootstrap -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #19 Verifica se o dbus está instalado
                    if ! dpkg -l | grep -qw dbus; then
                        pkg install --no-install-recommends dbus -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #20 Verifica se o pv está instalado
                    if ! dpkg -l | grep -qw pv; then
                        pkg install --no-install-recommends pv -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #21 Verifica se o git está instalado
                    if ! dpkg -l | grep -qw git; then
                        pkg install --no-install-recommends git -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #22 Verifica se o inxi está instalado
                    if ! dpkg -l | grep -qw inxi; then
                        pkg install --no-install-recommends inxi -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #23 Verifica se o rsync está instalado
                    if ! dpkg -l | grep -qw rsync; then
                        pkg install --no-install-recommends rsync -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #24 Verifica se o termux-api está instalado
                    if ! dpkg -l | grep -qw termux-api; then
                        pkg install --no-install-recommends termux-api -y > /dev/null 2>&1 # necessita do app Termux:API instalado no dispositivo
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #25 Verifica se o android-tools está instalado
                    if ! dpkg -l | grep -qw android-tools; then
                        pkg install --no-install-recommends android-tools -y > /dev/null 2>&1
                    fi
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #26 Todo o pacote de instalação
                    git clone --depth 1 -b alpha https://github.com/andistro/app.git app-andistro_setup  > /dev/null 2>&1
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #27 Extrai o pacote de instalação
                    rm -rf "$HOME/app-andistro_setup/.git"
                    rm -rf "$HOME/app-andistro_setup/andistro_setup"
                    rm -rf "$HOME/app-andistro_setup/README.md"
                    rm -rf "$HOME/app-andistro_setup/.editconfig"
                    rm -rf "$HOME/app-andistro_setup/.gitignore"
                    rm -rf "$HOME/app-andistro_setup/.gitattributes"
                    rm -rf "$HOME/app-andistro_setup/termos.sh"
                    mv -f "$HOME/app-andistro_setup/andistro" "$PREFIX/bin/andistro"
                    rsync -a "$HOME/app-andistro_setup/" "$PREFIX/var/lib/andistro/"
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    #28 Mover o Andistro
                    chmod +x "$PREFIX/bin/andistro"
                    chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
                    ((current_step++))
                    update_progress "$current_step" "$total_steps"; sleep 0.1

                    echo
                }
            elif [ "$2" == "dialog" ]; then
                show_progress_dialog steps-multi-label 40 \
                    "${label_progress}" 'sleep 1' \
                    "${label_find_update}" 'pkg update' \
                    "${label_find_update}" 'pkg install --no-install-recommends --option=Dpkg::Options::="--force-confnew" bash -y' \
                    "${label_find_update}" 'pkg install --no-install-recommends --option=Dpkg::Options::="--force-confnew" openssl -y' \
                    "${label_find_update}" 'pkg install --no-install-recommends --option=Dpkg::Options::="--force-confnew" apt -y' \
                    "${label_upgrade}" 'pkg upgrade -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends termux-exec -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends proot -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends x11-repo -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends termux-x11-nightly -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends pulseaudio -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends wget -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends dialog -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends tar -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends curl -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends unzip -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends xz-utils -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends debootstrap -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends dbus -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends pv -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends git -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends inxi -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends rsync -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends termux-api -y' \
                    "${label_install_script_download}" 'pkg install --no-install-recommends android-tools -y' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup"' \
                    "${label_install_script_download}" 'git clone --depth 1 -b alpha https://github.com/andistro/app.git app-andistro_setup' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.git"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/andistro_setup"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/README.md"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.editconfig"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.gitignore"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/app-andistro_setup/.gitattributes"' \
                    "${label_install_script_download}" 'mv -f "$HOME/app-andistro_setup/andistro" "$PREFIX/bin/andistro"' \
                    "${label_install_script_download}" 'mv -f "$HOME/app-andistro_setup/termos.sh" "$HOME/termos.sh"' \
                    "${label_install_script_download}" 'rsync -a "$HOME/app-andistro_setup/" "$PREFIX/var/lib/andistro/"' \
                    "${label_install_script_download}" 'chmod +x "$PREFIX/bin/andistro"' \
                    "${label_install_script_download}" 'chmod +x "$PREFIX/var/lib/andistro/lib/share/global"' \
                    "${label_install_script_download}" 'rm -rf "$HOME/storage"' \
                    "${label_install_script_download}" 'termux-setup-storage'
            else
                echo "$label_command_not_found: $2"
                exit 1
            fi
            
            rm -rf "$HOME/app-andistro_setup"
            rm -rf "$HOME/termos.sh"
            rm -rf andistro_setup.zip
            rm -rf "$HOME/andistro_setup"
            
            chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
            source "$PREFIX/var/lib/andistro/lib/share/global"
            echo -e "$label_update_finish"
            echo -e "\n$label_andistro_start_command_info"
        ;;

        # Comando para instalar uma distro
        -i)
            if [ -z "$2" ]; then
                distro_name="debian"
                distro_version="stable"
                distro_based="debian"
                distro_file="install-$distro_name.sh"

            elif [ "$2" == "terminal-mode" ]; then
                distro_name="debian"
                distro_version="stable"
                distro_based="debian"
                distro_file=".terminal_mode/install-$distro_name.sh"

            else 
                echo "$label_command_not_found: $2"
                exit 1
            fi

            echo "$label_wait" # Aguarde

            config_file="$andistro_files/manager/.config/$distro_based-based"
            bin="$andistro_files/manager/start-$distro_name"
            folder="$andistro_files/manager/$distro_name/$distro_version"
            
            mkdir -p "$PREFIX/var/lib/andistro/manager/$distro_name"

            # Cria diretórios necessários no armazenamento
            if [ ! -d "/sdcard/termux/andistro/manager/$distro_name/$distro_version" ];then
                mkdir -p "/sdcard/termux/andistro/manager/$distro_name/$distro_version"
            fi

            # Detectar arquitetura
            case `dpkg --print-architecture` in
                aarch64)
                    archurl="arm64"
                ;;
                arm)
                    archurl="armhf"
                ;;
                *)
                    echo "unknown architecture"; exit 1
                ;;
            esac

            # Menu de Ambiente Gráfico
            OPTIONS=(1 "${label_environments_select_default} (XFCE4)" # Interface padrão
                    2 "${label_environments_select_light} (LXDE)" # Interface leve
                    3 "${label_environments_select_null}")  # Nenhuma interface gráfica
            CHOICE=$(dialog --no-shadow --clear \
                            --title "$TITLE" \
                            --cancel-label "$label_back" \
                            --menu "$label_environments_select" \
                            $dialog_height $dialog_width $dialog_choice_height \
                            "${OPTIONS[@]}" \
                            2>&1 >/dev/tty)

            dialog_retorno=$?  # ← Captura código de retorno
            if [ $dialog_retorno -eq 1 ]; then
                clear # ← Clear se cancelado
                andistro
                exit 0
            fi
            clear
            case $CHOICE in
                # Interface padrão - XFCE4
                1)
                    config_environment="xfce4"
                ;;

                # Interface leve - LXDE
                2)	
                    config_environment="lxde"
                ;;
            esac

            # Menu de Tema
            OPTIONS=(1 "${label_light}" # Tema claro
                    2 "${label_dark}") # Tema escuro

            CHOICE=$(dialog --no-shadow --clear \
                            --title "$TITLE" \
                            --cancel-label "$label_back" \
                            --menu "$label_choose_theme" \
                            $dialog_height $dialog_width $dialog_choice_height \
                            "${OPTIONS[@]}" \
                            2>&1 >/dev/tty)
            
            dialog_retorno=$?  # ← Captura código de retorno
            if [ $dialog_retorno -eq 1 ]; then
                clear # ← Clear se cancelado
                andistro
                exit 0
            fi
            clear
            case $CHOICE in
                # Tema claro
                1)	
                    distro_theme="Light"
                ;;
                # Tema escuro
                2)	
                    distro_theme="Dark"
                ;;
            esac

            #andistro alerta timezone

            bash $PREFIX/var/lib/andistro/manager/$distro_file "$config_file" "$andistro_files" "$distro_name" "$bin" "$folder" "$binds" "$archurl" "$config_environment" "$distro_theme" "$distro_version"
            clear
            
            andistro -s
        ;;

        # Comando para desinstalar uma distro
        -d)
            if [ -z "$2" ]; then
                distro_name_upper="Debian"
                label_dialog_uninstall_menu_desc=$(printf "$label_dialog_uninstall_menu_desc" "$distro_name_upper")
                dialog --no-shadow \
                    --title "$label_dialog_uninstall_menu" \
                    --yes-label "$label_yes" \
                    --no-label "$label_no" \
                    --yesno "$label_dialog_uninstall_menu_desc" $dialog_height $dialog_width
                dialog_retorno=$?
                
                if [ $dialog_retorno -eq 0 ]; then
                    # Usuário escolheu "Sim"
                    echo "$label_wait"
                    distro_name="debian"
                    distro_name_upper="Debian"
                    label_uninstalling_system=$(printf "$label_uninstalling_system" "$distro_name_upper")
                else
                    # Usuário escolheu "Não"
                    label_uninstall_cancelled=$(printf "$label_uninstall_cancelled" "Debian")
                    andistro alerta uninstall-cancelled
                    exit 1
                fi

                show_progress_dialog steps-one-label "${label_uninstalling_system}" 5 \
                    "sleep 1" \
                    "sleep 1" \
                    "sleep 1" \
                    "rm -rf $andistro_files/manager/$distro_name" \
                    "rm -rf $andistro_files/manager/start-$distro_name"

                andistro alerta uninstall-success
            elif [ "$2" == "andistro" ]; then
                # Desinstalação total
                label_andistro_uninstalling_complete="$label_andistro_uninstalling_complete"
                distro_name_upper="AnDistro"
                label_dialog_uninstall_menu_desc=$(printf "$label_dialog_uninstall_menu_desc" "$distro_name_upper")
                dialog --no-shadow \
                    --title "$label_dialog_uninstall_menu" \
                    --yes-label "$label_yes" \
                    --no-label "$label_no" \
                    --yesno "$label_dialog_uninstall_menu_desc" $dialog_height $dialog_width

                dialog_retorno=$?

                if [ $dialog_retorno -eq 0 ]; then
                    # Usuário escolheu "Sim"
                    echo "$label_wait"
                    label_uninstalling_system=$(printf "$label_uninstalling_system" "$distro_name_upper")
                else
                    # Usuário escolheu "Não"
                    label_uninstall_cancelled=$(printf "$label_uninstall_cancelled" "AnDistro")
                    andistro alerta uninstall-cancelled
                    exit 1
                fi

                show_progress_dialog steps-one-label "${label_uninstalling_system}" 5 \
                    "sleep 1" \
                    "sleep 1" \
                    "sleep 1" \
                    "rm -rf $andistro_files" \
                    "rm -rf $PREFIX/bin/andistro"

                andistro alerta uninstall-success
                clear
                cat /data/data/com.termux/files/usr/etc/motd # exibe a mensagem padrão do Termux
            else
                    echo "$label_command_not_found: $2"
                    exit 1
            fi
            
        ;;

        # Comando para iniciar uma distro
        -s)
            if [ -z "$2" ]; then
                echo "$label_wait"
                if [ -f "$PREFIX/var/lib/andistro/manager/start-debian" ]; then
                    bash $PREFIX/var/lib/andistro/manager/start-debian
                else
                    label_distro_not_installed_desc=$(printf "$label_distro_not_installed_desc" "Debian")
                    echo -e "$label_distro_not_installed_desc"
                fi

            else
                echo "$label_command_not_found: $2"
                andistro terminal
                exit 1
            fi
        ;;

        # Comando para ver os comandos como terminal
        -t|terminal)
            start_debian=false
            
            if [ -f "$PREFIX/var/lib/andistro/manager/start-debian" ]; then # Verifica se o Debian está instalado
                    start_debian=true
            fi
            echo "$distro_command_guide" # Guia de comandos do AnDistro
            echo ""
            echo "$distro_desc_line_t1" #Exemplo de comando que permite a inicialização:
            echo "$distro_desc_line_t2" #andistro -s
            echo " "
            echo "$distro_desc_line_t3" #Exemplo de comando que permite a desinstalação:
            echo "$distro_desc_line_t4" #   andistro -d
            echo " "
            echo "$distro_desc_line_t5" #Exemplo de comando que permite a instalação:
            echo "$distro_desc_line_t6" #   andistro -i
            echo " "
            echo "$distro_desc_line_t7" #Exemplo de comando que permite a instalação sem interface gráfica
            echo "$distro_desc_line_t8" #andistro -i terminal-mode
            echo " "
            echo "$distro_desc_line_t9" #Exemplo de comando que permite a atualização do AnDistro:
            echo "$distro_desc_line_t10" #   andistro -u
            echo " "
            echo "$commands_available_to_you" #Comandos disponíveis para você:
            echo "$distro_desc_line_t11" #    -u  atualiza o AnDistro.
            if [ "$start_debian" = true ]; then  # ✅ Executa só se Debian estiver instalado
                echo "$distro_desc_line_t12" #    -s  inicia o Debian.
                echo "$distro_desc_line_t13" #    -d  desinstala o Debian.
            fi
            
            if [ "$start_debian" = false ]; then  # ✅ Executa só se Debian NÃO estiver instalado
                echo "$distro_desc_line_t14"     # -i instala o Debian.
            fi
        ;;

        # DevTools

        # Comando para configurar permissões e outras opções do Termux
        --setup)
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$label_command_not_found: $2"
            else
                case "$2" in
                    # Comando andistro --setup storage para configurar permissão de armazenamento
                    storage-permission)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow \
                                --gauge "$label_storage_permission_check" \
                                $dialog_height $dialog_width
                        clear
                        while true; do
                            if mkdir -p "/sdcard/termux" 2>/dev/null; then
                                # Sucesso: tem acesso ao armazenamento
                                rmdir "/sdcard/termux" 2>/dev/null || true
                                {
                                    for i in {1..50}; do
                                        sleep 0.1
                                        echo $((i * 2))
                                    done
                                } | dialog --no-shadow \
                                        --gauge "$label_storage_permission_granted\n\n$label_sleep_in_10s" $dialog_height $dialog_width
                                clear
                                break   # segue o script normalmente
                            fi

                            # Falhou: provavelmente sem permissão de armazenamento
                            rm -rf "$HOME/storage"
                            termux-setup-storage &

                            dialog --no-shadow --clear \
                                --title "$label_storage_permission" \
                                --yes-label "$label_permission_granted" \
                                --no-label "$label_permission_not_granted" \
                                --yesno "$label_storage_permission_desc" $dialog_height $dialog_width

                            dialog_retorno=$?

                            if [ $dialog_retorno -eq 0 ]; then
                                # Botão "Já permiti": tenta de novo no próximo loop
                                continue
                            else
                                # Botão "Não consegui": ajuda + intents
                                dialog --no-shadow --title "$label_permission_help" \
                                    --ok-label "$label_open_configs" \
                                    --msgbox "$label_storange_permission_help_desc" $dialog_height $dialog_width

                                # 1) Tela de gerenciamento de TODOS os arquivos para o Termux (Android 11+)
                                am start \
                                    -a android.settings.MANAGE_APP_ALL_FILES_ACCESS_PERMISSION \
                                    -d "package:com.termux" >/dev/null 2>&1
                            fi
                        done
                    ;;

                    # Comando andistro --setup battery para configurar permissão de ignorar otimização de bateria
                    battery)
                        # Configurações de otimização de bateria
                        # 1) Explica o que fazer
                        dialog --no-shadow --title "$label_battery_optimization" \
                            --ok-label "$label_open_configs" \
                            --msgbox "$label_battery_optimization_desc" $dialog_height $dialog_width

                        # 2) Abre tela de detalhes do app (de lá o usuário acessa Bateria)
                        am start -a android.settings.IGNORE_BATTERY_OPTIMIZATION_SETTINGS >/dev/null 2>&1

                        # 3) Após o usuário voltar ao Termux, apenas confirma (ambos saem)
                        dialog --no-shadow --clear \
                        --title "$label_battery_optimization" \
                        --ok-label "$label_next" \
                        --msgbox "$label_battery_optimization_desc_info" $dialog_height $dialog_width
                    ;;

                    # Comando andistro --setup termux-details-settings para abrir as informações do Termux no sistema
                    termux-details-settings)
                        dialog --no-shadow --title "$label_termux_settings" \
                            --msgbox "$label_open_termux_settings" $dialog_height $dialog_width
                        am start -a android.settings.APPLICATION_DETAILS_SETTINGS -d "package:com.termux"
                    ;;

                    avnc)
                        dialog --no-shadow --title "$label_install AVNC" \
                            --backtitle "$label_warning" \
                            --yes-label "$label_install" \
                            --no-label "$label_ignore" \
                            --yesno "$label_avnc_desc" $dialog_height $dialog_width
                        
                        dialog_retorno=$?

                        if [ $dialog_retorno -eq 0 ]; then
                            am start -a android.intent.action.VIEW -d "https://github.com/andistro/wiki"    
                        else
                            echo " "
                        fi

                        exit 0
                    ;;

                    phantom-procs)
                        dialog --no-shadow --title "$label_attention" \
                            --backtitle "$label_warning" \
                            --yes-label "$label_help" \
                            --no-label "$label_skip" \
                            --yesno "$label_phantom_procs_desc" $dialog_height $dialog_width

                        dialog_retorno=$?

                        if [ $dialog_retorno -eq 0 ]; then
                            am start -a android.intent.action.VIEW -d "https://github.com/andistro/wiki/blob/main/pt-BR/resolucao-de-problemas.md#corrigindo-o-problema-da-parada-for%C3%A7ada-do-sistema-no-termux--process-completed-signal-9--press-enter---"
                        else
                            echo " "
                        fi

                        exit 0
                    ;;

                    autoboot)
                        dialog --no-shadow --title "$label_attention" \
                                --backtitle "$label_warning" \
                                --yes-label "$label_yes" \
                                --no-label "$label_no" \
                                --yesno "$label_autoboot_andistro_desc" $dialog_height $dialog_width

                        dialog_retorno=$?

                        if [ $dialog_retorno -eq 0 ]; then
                            BASHRC_FILE="$PREFIX/etc/bash.bashrc"

                            if [[ -f "$BASHRC_FILE" ]]; then
                                # Remove só seção AnDistro antiga, se existir
                                sed -i '/# AnDistro: Confirmação de autoboot/,/# AnDistro: Fim da confirmação de autoboot/ d' "$BASHRC_FILE"

                                # Backup ANTES de gravar nova seção
                                cp "$BASHRC_FILE" "$BASHRC_FILE.bak.$(date +%Y%m%d_%H%M%S)"
                            fi

                            CONFIRM_CODE=$(cat << 'EOF'
# ========================================
# AnDistro: Confirmação de autoboot
# ========================================
if command -v andistro >/dev/null 2>&1; then
    source "$PREFIX/var/lib/andistro/lib/share/global" 2>/dev/null || true

    msg_andistro=$(printf "$label_open_app_desc" "Andistro")

    echo
    echo -e "\e[1;33m$msg_andistro\e[0m"

    trap "echo -e '\n\e[1;32m$label_cancel_action_ctrlc\e[0m'; exec bash" INT
    read -rsn1 tecla
    trap - INT

    if [[ -z "$tecla" || "$tecla" == $'\r' || "$tecla" == $'\n' ]]; then
        echo -e "\n\e[1;32m$(printf "$label_opening" "Andistro")\e[0m"
        echo -e "\n\e[1;32m$label_continue_action_executed\e[0m"
        echo -e "\e[1;32m$label_action_accepted\n\n\e[0m"
        andistro >/dev/null 2>&1  # ← Sem & aqui!
        exec bash
    fi

    if [[ "$tecla" == $'\x1b' ]]; then
        echo -e "\n\e[1;32m$label_cancel_action_esc\e[0m"
    fi

    exec bash
fi
# ========================================
# AnDistro: Fim da confirmação de autoboot
# ========================================

EOF
)

                            echo "$CONFIRM_CODE" >> "$BASHRC_FILE"
                            chmod 644 "$BASHRC_FILE"

                            andistro alerta setup-apply
                        fi
                        exit 0
                    ;;

                    autoboot-disable)
                        dialog --no-shadow --title "$label_attention" \
                                --backtitle "$label_warning" \
                                --yes-label "$label_yes" \
                                --no-label "$label_no" \
                                --yesno "$label_autoboot_andistro_disable_desc" $dialog_height $dialog_width

                        dialog_retorno=$?

                        if [ $dialog_retorno -eq 0 ]; then
                            BASHRC_FILE="$PREFIX/etc/bash.bashrc"

                            if [[ -f "$BASHRC_FILE" ]]; then
                                # Backup antes de remover
                                cp "$BASHRC_FILE" "$BASHRC_FILE.bak.$(date +%Y%m%d_%H%M%S)"

                                # Remove só seção AnDistro
                                sed -i '/# AnDistro: Confirmação de autoboot/,/# AnDistro: Fim da confirmação de autoboot/ d' "$BASHRC_FILE"

                                chmod 644 "$BASHRC_FILE"
                                andistro alerta setup-apply
                            fi
                        fi
                        exit 0
                        ;;

                    adb)

                    ;;

                    *)
                        echo "$label_command_not_found: $2"
                        ;;
                esac
            fi
        ;;
        
        # Comando para editar scripts e módulos do Andistro
        --set-edit)
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                nano "$PREFIX/bin/andistro"
            else
                case "$2" in
                    install-debian)
                        nano "$PREFIX/var/lib/andistro/manager/install-debian.sh"
                        ;;
                    start-debian)
                        nano "$PREFIX/var/lib/andistro/manager/start-debian"
                        ;;
                    module-global)
                        nano "$PREFIX/var/lib/andistro/lib/share/global"
                        ;;
                    module-locale)
                        nano "$PREFIX/var/lib/andistro/lib/share/locales_${system_icu_locale_code}.sh"
                        ;;
                    *)
                        echo "$label_command_not_found: $2"
                        ;;
                esac
            fi
        ;;

        # Comando para exibir alertas do Andistro
        alerta)
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$label_command_not_found"
            else
                case "$2" in
                    timezone)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_distro_alert_timezone_desc} \n$label_distro_alert_timezone_detected $system_timezone\n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    install-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_install_success} \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    uninstall-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_uninstall_success} \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    uninstall-canelled)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_uninstall_cancelled} \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    dialog-display)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_start_dialog_display \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    setup-apply)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_setup_apply \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    *)
                        echo "$label_command_not_found: $2"
                        ;;
                esac
            fi
        ;;
        # Erro
        *)
            echo "$label_command_not_found $1"
            exit 1
            ;;
    esac
   
#=================================================================================================
elif [ -r /etc/os-release ] && grep -Eq '^ID=(debian|ubuntu)' /etc/os-release; then # Debian/Ubuntu
    source "/usr/local/lib/andistro/global"
#>>>#=============================================================================================
#>>># Menu principal do Andistro
    if [ -z "$1" ]; then
        echo "$distro_command_guide" # Guia de comandos do AnDistro
        echo " "
        echo "$distro_desc_line_0_0" # Use: andistro <comando> <subcomando> para seja feito a tarefa desejada.
        echo " "
        echo "$commands_available_to_you" # Comandos disponíveis:
        echo "$distro_desc_line_d1" #     --boot  comando para iniciar alguma configuração.
        echo " "
        echo "$distro_desc_line_d2" # Subcomandos do --boot
        echo "$distro_desc_line_d3" #     vnc  para iniciar o servidor VNC
        echo " "
        echo "$distro_desc_line_d4" # Subcomandos do --boot vnc
        echo "$distro_desc_line_d5" #     --display  define a resolução da tela que será exibida
        echo "$distro_desc_line_d6" #     --scale    define a escala da tela (1 ou 2)
        echo "$distro_desc_line_d7" #     --port     define a porta usada pelo servidor.
        echo "$distro_desc_line_d8" # O comando --scale só funciona no xfce4, caso use no lxde, o comando será ignorado
        echo "$distro_desc_line_d9" # O comando --display e --port não são obrigatórios e caso não use o servidor será iniciado na resolução e porta padrão.
        echo " "
        echo "$distro_desc_line_d10" # Exemplo de comando que permite a inicialização do servior vnc
        echo "$distro_desc_line_d11" # Modo simples
        echo "$distro_desc_line_d12" #   andistro --boot vnc
        echo "$distro_desc_line_d13" # Modo completo
        echo "$distro_desc_line_d14" #   andistro --boot vnc --display 1920x1080 --port 1 --scale 1
        echo " "
        exit 0
    fi

#>>>#=============================================================================================
#>>># Ações para funcionar nas distribuições Debian/Ubuntu

    case "$1" in
        # Comando para exibir alertas do Andistro
        alerta)
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$label_command_not_found"
            else
                case "$2" in
                    timezone)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_distro_alert_timezone_desc} \n$label_distro_alert_timezone_detected $system_timezone\n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    install-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_install_success} \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    uninstall-success)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "${label_uninstall_success} \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    dialog-display)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_start_dialog_display \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    setup-apply)
                        {
                            for i in {1..50}; do
                                sleep 0.1
                                echo $((i * 2))
                            done
                        } | dialog --no-shadow --gauge "$label_setup_apply \n\n$label_sleep_in_10s" $dialog_height $dialog_width
                        clear
                        ;;
                    *)
                        echo "$label_command_not_found: $2"
                        ;;
                esac
            fi
        ;;
        # Bridge direto Debian → Termux
        --termux-cmd)
            shift
            cmd="$*"

            if [ -z "$cmd" ]; then
                echo "$label_no_command_informed"
                exit 1
            fi

            file="/termux/home/andistro-bridge"
            status_file="/termux/home/andistro-status"
            output_file="/termux/home/andistro-output"
            error_file="/termux/home/andistro-error"

            if [ ! -d "/termux/home" ]; then
                echo "$label_error_dir_termux_home_not_accessible"
                exit 1
            fi

            # limpa status/erro anteriores
            rm -f "$status_file" "$error_file" "$output_file"

            # envia comando para o Termux
            printf "%s\n" "$cmd" > "$file" 2>/dev/null || {
                echo "$label_error_bridge_unavailable"
                exit 1
            }

            # espera o Termux dialog_retornoonder com o status (timeout ~10s)
            for i in {1..20}; do
                if [ -f "$status_file" ]; then
                    status=$(cat "$status_file")
                    rm -f "$status_file"

                    # Mostra saída completa do Termux
                    if [ -f "$output_file" ] && [ -s "$output_file" ]; then
                        cat "$output_file"
                    fi
                    
                    # Error_file opcional para detalhes
                    if [ -f "$error_file" ] && [ -s "$error_file" ]; then
                        echo -e "\n\e[1;31mErro detalhado:\e[0m"
                        cat "$error_file"
                    fi

                    exit "$status"
                fi
                sleep 0.5
            done

            echo "$label_error_bridge_timeout"
            exit 1
        ;;

        # Comando para iniciar alguma configuração
        --boot)
            shift
            
            # Comando para iniciar o servidor VNC
            if [[ "$1" == "vnc" ]]; then
                shift 
                DISPLAY_VALUE=""
                PORT_VALUE=""
                SCALE_VALUE=""
                # Subcomandos do vnc
                while [[ $# -gt 0 ]]; do
                    case "$1" in
                        --display)
                            DISPLAY_VALUE="$2"
                            #echo "Display set to $DISPLAY_VALUE"
                            shift 2
                            ;;
                        --scale)
                            SCALE_VALUE="$2"
                            #echo "Scale set to $SCALE_VALUE"
                            shift 2
                            ;;
                        --port)
                            PORT_VALUE="$2"
                            #echo "Port set to $PORT_VALUE"
                            shift 2
                            ;;
                        --kill)
                            # Buscar arquivos PID relacionados ao usuário
                            PID_FILES=$(ls -1 $HOME/.vnc/localhost:* 2>/dev/null)

                            # Verificar se há servidores ativos
                            if [ -z "$PID_FILES" ]; then
                                echo "$label_server_kill_desc_error"
                                exit 1
                            fi
                            # Extrair a porta do primeiro arquivo encontrado (ex: localhost:1.pid → 1)
                            PORTA=$(echo "$PID_FILES" | head -n1 | cut -d':' -f2 | cut -d'.' -f1)
                            echo "$label_server_kill_desc"
                            echo "$label_server_kill_desced: $PORTA"
                            # Parar o servidor VNC
                            vncserver -kill :$PORTA
                            # Remover arquivos temporários
                            rm -rf /tmp/.X$PORTA-lock
                            rm -rf /tmp/.X*-lock
                            rm -rf /tmp/.X11-unix/X$PORTA
                            rm -rf /tmp/.X11-unix/X*
                            shift
                            exit 1
                            ;;
                        --passwd)
                            while true; do # Loop até obter uma senha válida ou o usuário cancelar
                                PASSWORD=$(dialog --no-shadow --insecure --passwordbox "$label_password_input\n\n$label_keyboard_active_sugest" $dialog_height $dialog_width 3>&1 1>&2 2>&3)
                                if [ $? -eq 0 ]; then
                                    # Valida senha não vazia
                                    if [ -z "$PASSWORD" ]; then
                                        dialog --no-shadow --title "$label_error" --msgbox "$label_password_input_alert_important" $dialog_height $dialog_width
                                        continue
                                    fi
                                    break
                                else
                                    echo "${label_entry_canceled}"
                                    exit 1
                                fi

                            done

                            #Salvar a senha no arquivo apropriado
                            if ! /usr/bin/vncpasswd -f <<<"$PASSWORD"$'\n'"$PASSWORD" > "$HOME/.vnc/passwd"; then
                                dialog --no-shadow --title "$label_error" --msgbox "$label_password_save_failed" $dialog_height $dialog_width
                                exit 1
                            fi

                            # Proteger o arquivo com permissão segura
                            chmod 600 $HOME/.vnc/passwd

                            # Barra de progresso
                            {
                                for ((i = 0; i <= 100; i+=2)); do
                                    sleep 0.08
                                    echo $i
                                done
                            } | dialog --no-shadow --gauge "${label_change_password}" $dialog_height $dialog_width
                            shift
                            exit 1
                            ;;
                        --dialog-display)
                            timestamp=$(date +'%d%m%Y-%H%M%S')
                            andistro --boot vnc --kill >/dev/null 2>&1 # Para garantir que nenhum servidor VNC esteja rodando antes de iniciar um novo
                            #=====================================================================================
                            #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                            # Painel de seleção de resolução
                            #//////////////////////////////////////////////////////////////////////////////////////
                            #=====================================================================================
                            # Identificador de resolução repetida - Início
                            RESOLUTION_LOG="$HOME/.server_resolution_history"

                            # Criar arquivo de log se não existir
                            if [[ ! -f "$RESOLUTION_LOG" ]]; then
                                touch "$RESOLUTION_LOG"
                            fi

                            # Função para salvar resolução no histórico
                            save_resolution() {
                                local res="$1"
                                echo "$res|$(date +%s)" >> "$RESOLUTION_LOG"
                            }

                            # Função para verificar resoluções repetidas
                            check_repeated_resolution() {
                                local current_res="$1"
                                local count=0
                                local recent_count=0
                                local time_threshold=$(($(date +%s) - 604800)) # últimos 7 dias
                                
                                while IFS='|' read -r res timestamp; do
                                    if [[ "$res" == "$current_res" ]]; then
                                        ((count++))
                                        if [[ $timestamp -ge $time_threshold ]]; then
                                            ((recent_count++))
                                        fi
                                    fi
                                done < "$RESOLUTION_LOG"
                                
                                # Se foi usado 3+ vezes no total ou 2+ vezes na última semana
                                if [[ $count -ge 3 ]] || [[ $recent_count -ge 2 ]]; then
                                    return 0 # resolução repetida detectada
                                else
                                    return 1 # não é repetida o suficiente
                                fi
                            }

                            # Função para perguntar se quer definir como padrão
                            ask_set_default() {
                                local res="$1"
                                label_resolution_frequent_desc=$(eval echo -e "\"$label_resolution_frequent_desc\"" | sed "s/%s/$res/")

                                dialog --no-shadow --backtitle "$label_server_setup" \
                                    --title "$label_resolution_frequent" \
                                    --yesno "$label_resolution_frequent_desc" $dialog_height $dialog_width
                                return $?
                            }

                            # Função para salvar resolução padrão
                            save_default_resolution() {
                                local res="$1"
                                local port="$2"
                                local scale="$3"
                                echo "RESOLUTION=$res" >> $HOME/.sever_resolution_default
                                echo "PORT=$port" >> $HOME/.sever_resolution_default
                                echo "SCALE=$scale" >> $HOME/.sever_resolution_default
                            }

                            # Verificar se existe resolução padrão
                            if [[ -f $HOME/.sever_resolution_default ]]; then
                                source $HOME/.sever_resolution_default

                                if [[ "$RESOLUTION" =~ ^([0-9]+)x([0-9]+)$ ]]; then
                                    andistro --boot vnc --display "$RESOLUTION" --port ${PORT:-1} --scale ${SCALE:-1}
                                    exit 0
                                fi
                            fi

                            HEIGHT=0
                            WIDTH=0
                            CHOICE_HEIGHT=10
                            BACKTITLE="${label_select_resolution}"
                            TITLE="${label_select_resolution}"
                            MENU="${label_choose_one_resolution}"
                            export PORT=1

                            OPTIONS=(1 "${label_resolution_option_custom}"
                                    2 "${label_resolution_choose_options}")

                            CHOICE=$(dialog --no-shadow --no-shadow --clear \
                                            --backtitle "$BACKTITLE" \
                                            --title "$TITLE" \
                                            --menu "$MENU" \
                                            $dialog_height $dialog_width $dialog_choice_height \
                                            "${OPTIONS[@]}" \
                                            2>&1 >/dev/tty)
                            clear

                            case $CHOICE in

                                1) 
                                    # Resolução manual
                                    while true; do
                                        RESOLUTION=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom \n $label_resolution_choose_custom_desc" $dialog_height $dialog_width 3>&1 1>&2 2>&3 3>&-)
                                        if [ $? -ne 0 ]; then
                                            andistro --boot vnc --dialog-display
                                            exit 0
                                        fi
                                        if [ -n "$RESOLUTION" ]; then
                                            break
                                        else
                                            dialog --msgbox "$label_resolution_choose_custom_desc_alert" $dialog_height $dialog_width
                                        fi
                                    done

                                    while true; do
                                        PORT=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom_desc_port" $dialog_height $dialog_width 1 3>&1 1>&2 2>&3 3>&-)
                                        if [ $? -ne 0 ]; then
                                            andistro --boot vnc --dialog-display
                                            exit 0
                                        fi
                                        # Aceita vazio ou valor, sem validação obrigatória, sai do loop
                                        # Define valor padrão 1 se vazio
                                        if [ -z "$PORT" ]; then
                                            PORT=1
                                        fi
                                        break
                                    done

                                    SCALE=""

                                    if pgrep -x "xfce4-session" > /dev/null; then
                                        while true; do
                                            SCALE=$(dialog --no-shadow --inputbox "$label_resolution_choose_custom_desc_scale" $dialog_height $dialog_width 1 3>&1 1>&2 2>&3 3>&-)
                                            if [ $? -ne 0 ]; then
                                                andistro --boot vnc --dialog-display
                                                exit 0
                                            fi
                                            # Pode validar o valor do scale aqui se quiser, ou aceitar vazio
                                            break
                                        done
                                    fi

                                    current_resolution="$RESOLUTION"
                                    save_resolution "$current_resolution"
                                    
                                    if check_repeated_resolution "$current_resolution"; then
                                        if ask_set_default "$current_resolution"; then
                                            save_default_resolution "$current_resolution" "$PORT" "$SCALE"
                                            echo "$label_resolution_option_custom ($current_resolution)" $dialog_height $dialog_width
                                        fi
                                    fi

                                    CMD="andistro --boot vnc --display $RESOLUTION --port $PORT"

                                    if [ -n "$SCALE" ]; then
                                        CMD="$CMD --scale $SCALE"
                                    fi

                                    $CMD

                                ;;
                                2)
                                    #Lista de resoluções
                                    OPTIONS=(1 "${label_landscape}"
                                            2 "${label_portrait}")

                                    CHOICE=$(dialog --no-shadow --clear \
                                            --backtitle "$BACKTITLE" \
                                            --title "$TITLE" \
                                            --menu "$MENU" \
                                            $dialog_height $dialog_width $dialog_choice_height \
                                            "${OPTIONS[@]}" \
                                            2>&1 >/dev/tty)
                                    clear
                                    case $CHOICE in
                                        1)
                                            #Horizontal
                                            OPTIONS=(1 "${label_resolution_option_uwhd} (2560x1080)"
                                                    2 "${label_resolution_option_qdhd} (2560x1440)"
                                                    3 "${label_resolution_option_fhd} (1440x1080)"
                                                    4 "${label_resolution_option_fhd_wide} (1920x1080)"
                                                    5 "${label_resolution_option_hd} (1280x720)")

                                            CHOICE=$(dialog --no-shadow --clear \
                                                            --backtitle "$BACKTITLE" \
                                                            --title "$TITLE" \
                                                            --menu "$MENU" \
                                                            $dialog_height $dialog_width $dialog_choice_height \
                                                            "${OPTIONS[@]}" \
                                                            2>&1 >/dev/tty)
                                            clear

                                            case $CHOICE in
                                                1)
                                                    #Ultrawide HD 
                                                    current_resolution="2560x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_uwhd ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                2)
                                                    #Quad-HD
                                                    current_resolution="2560x1440"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_qdhd ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                3)
                                                    #Full-HD
                                                    current_resolution="1440x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                4)
                                                    #Full-HD estendido
                                                    current_resolution="1920x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd_wide ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                5)
                                                    #HD
                                                    current_resolution="1280x720"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_hd ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                            esac
                                        ;;
                                        2)
                                            #Vertical
                                            OPTIONS=(1 "${label_resolution_option_qdhd} (1440x2560)"
                                                    2 "${label_resolution_option_fhd} (1080x1440)"
                                                    3 "${label_resolution_option_hd} (1280x720)")

                                            CHOICE=$(dialog --no-shadow --clear \
                                                            --backtitle "$BACKTITLE" \
                                                            --title "$TITLE" \
                                                            --menu "$MENU" \
                                                            $dialog_height $dialog_width $dialog_choice_height \
                                                            "${OPTIONS[@]}" \
                                                            2>&1 >/dev/tty)
                                            clear

                                            case $CHOICE in
                                                1)
                                                    #Quad-HD
                                                    current_resolution="1440x2560"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_qdhd_wide ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                2)
                                                    #Full-HD
                                                    current_resolution="1080x1440"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                                3)
                                                    #HD
                                                    current_resolution="720x1080"
                                                    save_resolution "$current_resolution"
                                                    
                                                    if check_repeated_resolution "$current_resolution"; then
                                                        if ask_set_default "$current_resolution"; then
                                                            save_default_resolution "$current_resolution" "1" "1"
                                                            echo "$label_resolution_option_fhd_wide ($current_resolution)" $dialog_height $dialog_width
                                                        fi
                                                    fi
                                                    andistro --boot vnc --display "$current_resolution" --port 1 --scale 1
                                                ;;
                                            esac

                                        ;;
                                    esac
                                ;;

                            esac
                            shift
                            exit 1
                            ;;
                        *)
                            echo "Comando ou parâmetro desconhecido: $1"
                            shift
                        ;;
                    esac
                done

                # Validar se a porta foi fornecida
                if [[ -z "$PORT_VALUE" ]]; then
                    PORT_VALUE="1"
                fi

                # Função para salvar resolução padrão             
                if [[ -n "$DISPLAY_VALUE" ]]; then
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop $DISPLAY_VALUE :$PORT_VALUE"

                    vncserver -localhost no -depth 24 -name andistro-desktop -geometry "$DISPLAY_VALUE" :$PORT_VALUE
                    #vncserver -localhost no -depth 24 -name remote-desktop -geometry "1920x1080" :1
                else
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop :$PORT_VALUE"
                    vncserver -localhost no -depth 24 -name andistro-desktop :"$PORT_VALUE"
                    #vncserver -localhost no -depth 24 -name remote-desktop :1
                fi
                
                # Verifica se o vncserver está rodando
                if pgrep -x "Xtigervnc" > /dev/null; then
                    # Se xfce4-session estiver rodando executa o comando de escala
                    if pgrep -x "xfce4-session" > /dev/null && [ -n "$SCALE_VALUE" ]; then
                        xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s "$SCALE_VALUE"
                    fi

                    echo -e "\n${label_server_start_desc}"
                    echo
                    echo -e "\033[1;96m${label_user}:\033[0m $USER\n"
                    echo
                    echo -e "\033[1;96m${label_localhost}:\033[0m $HOSTNAME\033[1;33m:\033[0m$PORT \033[1;33m/\033[0m 120.0.0.1\033[1;33m:\033[0m$PORT \033[1;33m/\033[0m $wlan_ip_localhost\033[1;33m:\033[0m$PORT"
                    echo
                    echo -e "\033[1;35m${label_password_forgot}\033[0m"
                    echo
                    echo -e "\033[1;38;5;208m${label_server_kill_desc_help}\033[0m"
                    echo
                    # Pergunta para abrir o AVNC
                    label_open_app_desc=$(printf "$label_open_app_desc" "AVNC")
                    echo -e "\e[1;33m$label_open_app_desc\e[0m"

                    # CTRL+C → cancelar de forma clara
                    trap 'echo -e "\n\e[1;32m$label_cancel_action_ctrlc\e[0m"; exit 0' INT
                    read -s -n1 tecla
                    trap INT  # Remove o trap imediatamente após read

                    # ENTER → executa
                    if [[ -z "$tecla" || "$tecla" == $'\r' || "$tecla" == $'\n' ]]; then
                        label_opening=$(printf "$label_opening" "AVNC")
                        echo -e "\n\e[1;32m$label_opening\e[0m"
                        echo -e "\n\e[1;32m$label_continue_action_executed\e[0m"
                        echo -e "\e[1;32m$label_action_accepted\n\n$label_app_not_open\e[0m"
                        andistro --termux-cmd "am start -d vnc://localhost:1?ConnectionName=AnDistro&SaveConnection=true" >/dev/null 2>&1
                        exit 1
                    fi

                    # ESC → cancela com mensagem
                    if [[ "$tecla" == $'\x1b' ]]; then
                        echo -e "\n\e[1;32m$label_cancel_action_esc\e[0m"
                        exit 1
                    fi

                    # Qualquer outra tecla → não confirma nem cancela, só volta silenciosamente
                    # (nenhum echo, nenhum diálogo, apenas fim do script)
                    exit 0

                else
                    echo "$label_server_start_error"
                fi
            fi
        ;;
        
        # Erro
        *)
            echo "$label_command_not_found $1"
            exit 1
        ;;
    esac
#=================================================================================================
else # Nenhum dos dois
    echo "$label_system_not_found"
fi
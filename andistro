#!/bin/bash

inxi_out=$(inxi -F 2>/dev/null)

# Template de verificação do sistema operacional
# if echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
#   echo "Executando comando para Debian/Ubuntu"
# elif echo "$inxi_out" | grep -q 'Distro:.*Android'; then
#   echo "Executando comando para Android"
# else
#   echo "Sistema não identificado"
# fi

# if echo "$inxi_out" | grep -q 'Distro:.*Android'; then

# elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then

# else
#   echo "Sistema não identificado"
# fi

if echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
    # Disponível somente apara as distribuições
    if [ -f "/usr/local/lib/andistro/global" ]; then
        source /usr/local/lib/andistro/global
    fi
elif echo "$inxi_out" | grep -q 'Distro:.*Android'; then
    # Disponível apenas para o Android
    rm -rf $HOME/storage
    termux-setup-storage

    # Cria os diretórios necessários
    if [ ! -d "$PREFIX/var/lib/andistro/" ];then
        mkdir -p "$PREFIX/var/lib/andistro/"
        mkdir -p "$PREFIX/var/lib/andistro/lib/share/"
        mkdir -p "$PREFIX/var/lib/andistro/lib/share/locales/"
        mkdir -p "$PREFIX/var/lib/andistro/boot/"
    fi

    if [ -f "$PREFIX/var/lib/andistro/lib/share/global" ]; then
        source $PREFIX/var/lib/andistro/lib/share/global
    fi

    andistro_files="$PREFIX/var/lib/andistro"

    # Configurações do Termux
    # Verifica se a configuração já foi aplicada
    if grep -q "^# hide-soft-keyboard-on-startup = true"  ~/.termux/termux.properties; then
    # Descomenta a linha removendo o '#' no começo
    sed -i "s/^# hide-soft-keyboard-on-startup = true/hide-soft-keyboard-on-startup = true/"  ~/.termux/termux.properties
    termux-reload-settings
    fi

    # Adiciona a configuração de teclas extras se não estiver presente
    if ! grep -Fq "extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]" ~/.termux/termux.properties; then
        # Aplica os sed
        sed -i "s|^# *extra-keys = \[\['ESC','/','-','HOME','UP','END','PGUP'\], \\\\|extra-keys = [['DRAWER','PASTE'],['ESC','/','-','HOME','UP','END','PGUP','KEYBOARD'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN','ENTER']]|" ~/.termux/termux.properties
        sed -i "s|^#[[:space:]]*\['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN']]||" ~/.termux/termux.properties

        # Recarrega Termux settings
        termux-reload-settings
    fi
else
  echo "Sistema não identificado"
fi

# Log de erros
if [ ! -d "/sdcard/termux/andistro/logs" ];then
    mkdir -p "/sdcard/termux/"
    mkdir -p "/sdcard/termux/andistro"
    mkdir -p "/sdcard/termux/andistro/distros"
    mkdir -p "/sdcard/termux/andistro/logs"
    touch "/sdcard/termux/andistro/logs/.nomedia"
fi

ANDISTRO_LOG="/sdcard/termux/andistro/logs"

#Verifica se o andistro está em $HOME

#=============================================================================================
# COMANDOS
#=============================================================================================
if [ -z "$1" ]; then
    if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
        HEIGHT=0
        WIDTH=100
        CHOICE_HEIGHT=5
        export PORT=1

        if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
            OPTIONS=(s "$label_system_start"
                    d "$label_system_uninstall"
                    i "$label_system_install_other_systems"
                    u "$label_andistro_updater"
                    t "$label_andistro_termianl_viewer")
        else
            OPTIONS=(i "$label_system_install_systems"
                    u "$label_andistro_updater"
                    t "$label_andistro_termianl_viewer")
        fi

        CHOICE=$(dialog --no-shadow --clear \
            --title "AnDistro" \
            --menu "$label_choose_one_of_the_option:" \
            $HEIGHT $WIDTH $CHOICE_HEIGHT \
            "${OPTIONS[@]}" \
            2>&1 >/dev/tty)
        clear
        case $CHOICE in
            i)
                OPTIONS=(d "Debian"
                        u "Ubuntu"
                        t "$label_andistro_termianl_viewer")

                CHOICE=$(dialog --no-shadow --clear \
                    --title "AnDistro" \
                    --menu "$label_choose_one_of_the_option:" \
                    $HEIGHT $WIDTH $CHOICE_HEIGHT \
                    "${OPTIONS[@]}" \
                    2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro  -i debian
                        ;;
                    u)
                        andistro -i ubuntu
                        ;;
                    t)
                        andistro -i
                        ;;
                esac
            ;;
            s)
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi

                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi

                if $start_debian && ! $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            t "$label_andistro_termianl_viewer")
                elif ! $start_debian && $start_ubuntu; then
                    OPTIONS=(u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                elif $start_debian && $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                else
                    # Não tem nenhum sistema instalado
                    OPTIONS=(. " ")
                fi

                CHOICE=$(dialog --no-shadow --clear \
                    --title "AnDistro" \
                    --menu "$label_choose_one_of_the_option:" \
                    $HEIGHT $WIDTH $CHOICE_HEIGHT \
                    "${OPTIONS[@]}" \
                    2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro -s debian
                        ;;
                    u)
                        andistro -s ubuntu
                        ;;
                    t)
                        andistro -s
                        ;;
                esac
            ;;
            u)
                andistro -u
                andistro
            ;;
            d)
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi

                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi

                if $start_debian && ! $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            t "$label_andistro_termianl_viewer")
                elif ! $start_debian && $start_ubuntu; then
                    OPTIONS=(u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                elif $start_debian && $start_ubuntu; then
                    OPTIONS=(d "Debian"
                            u "Ubuntu"
                            t "$label_andistro_termianl_viewer")
                else
                    # Não tem nenhum sistema instalado
                    OPTIONS=(. " ")

                fi

                CHOICE=$(dialog --no-shadow --clear \
                    --title "AnDistro" \
                    --menu "$label_choose_one_of_the_option:" \
                    $HEIGHT $WIDTH $CHOICE_HEIGHT \
                    "${OPTIONS[@]}" \
                    2>&1 >/dev/tty)
                case $CHOICE in
                    d)
                        andistro -d debian
                        
                        ;;
                    u)
                        andistro -d ubuntu
                        ;;
                    t)
                        andistro -d
                        ;;
                esac
            ;;
            t)
                andistro terminal
            ;;
        esac
    elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
        echo "$label_command_not_available"
    else
        echo "$label_system_not_found"
    fi
exit 0
fi

case "$1" in
    -u)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            echo -e "\n$distro_wait"
            update_progress() {
                current_step=$1
                total_steps=$2

                percent=$((current_step * 100 / total_steps))
                bar_length=30
                filled_length=$((percent * bar_length / 100))
                empty_length=$((bar_length - filled_length))

                filled_bar=$(printf "%${filled_length}s" | tr " " "=")
                empty_bar=$(printf "%${empty_length}s" | tr " " " ")

                printf "\r[%s%s] %3d%%" "$filled_bar" "$empty_bar" "$percent"
            }

            total_steps=26  # Número total de etapas que você quer monitorar
            current_step=0

            {
                #1 Atualiza os repositórios
                sleep 1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #2 Atualiza os repositórios
                pkg update > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #3 Instala o bash
                pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" bash -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #4 Instala o openssl
                pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" openssl -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #5 Instala o apt
                pkg install --no-install-recommends --option=Dpkg::Options::="--force-confold" apt -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #6 Atualiza os pacotes
                pkg upgrade -y > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #7 Verifica se o termux-exec está instalado
                if ! dpkg -l | grep -qw termux-exec; then
                    pkg install --no-install-recommends termux-exec -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #8 Verifica se o proot está instalado
                if ! dpkg -l | grep -qw proot; then
                    pkg install --no-install-recommends proot -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #9 Verifica se o x11-repo está instalado
                if ! dpkg -l | grep -qw x11-repo; then
                    pkg install --no-install-recommends x11-repo -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #10 Verifica se o termux-x11-nightly está instalado
                if ! dpkg -l | grep -qw termux-x11-nightly; then
                    pkg install --no-install-recommends termux-x11-nightly -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #11 Verifica se o pulseaudio está instalado
                if ! dpkg -l | grep -qw pulseaudio; then
                    pkg install --no-install-recommends pulseaudio -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #12 Verifica se o wget está instalado
                if ! dpkg -l | grep -qw wget; then
                    pkg install --no-install-recommends wget -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #13 Verifica se o dialog está instalado
                if ! dpkg -l | grep -qw dialog; then
                    pkg install --no-install-recommends dialog -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #14 Verifica se o tar está instalado
                if ! dpkg -l | grep -qw tar; then
                    pkg install --no-install-recommends tar -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #15 Verifica se o curl está instalado
                if ! dpkg -l | grep -qw curl; then
                    pkg install --no-install-recommends curl -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #16 Verifica se o unzip está instalado
                if ! dpkg -l | grep -qw unzip; then
                    pkg install --no-install-recommends unzip -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #17 Verifica se o xz-utils está instalado
                if ! dpkg -l | grep -qw xz-utils; then
                    pkg install --no-install-recommends xz-utils -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #18 Verifica se o debootstrap está instalado
                if ! dpkg -l | grep -qw debootstrap; then
                    pkg install --no-install-recommends debootstrap -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #19 Verifica se o dbus está instalado
                if ! dpkg -l | grep -qw dbus; then
                    pkg install --no-install-recommends dbus -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #20 Verifica se o pv está instalado
                if ! dpkg -l | grep -qw pv; then
                    pkg install --no-install-recommends pv -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #21 Verifica se o git está instalado
                if ! dpkg -l | grep -qw git; then
                    pkg install --no-install-recommends git -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #22 Verifica se o inxi está instalado
                if ! dpkg -l | grep -qw inxi; then
                    pkg install --no-install-recommends inxi -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #23 Verifica se o rsync está instalado
                if ! dpkg -l | grep -qw rsync; then
                    pkg install --no-install-recommends rsync -y > /dev/null 2>&1
                fi
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #24 Todo o pacote de instalação
                git clone -b alpha https://github.com/andistro/app.git app-andistro_setup  > /dev/null 2>&1
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #25 Extrai o pacote de instalação
                rm -rf "$HOME/app-andistro_setup/.git"
                rm -rf "$HOME/app-andistro_setup/andistro_setup"
                rm -rf "$HOME/app-andistro_setup/README.md"
                rm -rf "$HOME/app-andistro_setup/termos.sh"
                mv -f "$HOME/app-andistro_setup/andistro" "$PREFIX/bin/andistro"
                rsync -a "$HOME/app-andistro_setup/" "$PREFIX/var/lib/andistro/"
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                #26 Mover o Andistro
                chmod +x "$PREFIX/bin/andistro"
                chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
                chmod +x $PREFIX/var/lib/andistro/boot/.config/*/bin/*
                ((current_step++))
                update_progress "$current_step" "$total_steps"; sleep 0.1

                echo
            }
            rm -rf "$HOME/app-andistro_setup"
            rm -rf andistro_setup.zip
            rm -rf "$HOME/andistro_setup"
            
            chmod +x "$PREFIX/var/lib/andistro/lib/share/global"
            source "$PREFIX/var/lib/andistro/lib/share/global"
            echo -e "$label_update_finish"
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
        echo "$label_system_not_found"
        fi
        ;;

    -i)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if [ -z "$2" ]; then
                if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                    #Existe pelo menos um arquivo start-*
                    echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                    echo ""
                    echo "$distro_desc_line_6" #Exemplo de comando que permite a instalação:
                    echo "$distro_desc_line_7" #andistro -i debian
                    echo " "
                    echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                    echo "$distro_desc_line_9" #   andistro -u
                    echo " "
                    echo "$distro_desc_line_10" #Comandos disponíveis para você:
                    echo "$distro_desc_line_13" #    -i  instala a opção escolhida.
                    echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                    echo "   debian"
                    echo "   ubuntu"
                    echo " "
                    echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                    start_debian=false
                    start_ubuntu=false
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                        start_debian=true
                    fi
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                        start_ubuntu=true
                    fi
                    if $start_debian && ! $start_ubuntu; then
                        echo "   ubuntu" #se já existe o start-debian, mostra apenas o ubuntu
                        elif ! $start_debian && $start_ubuntu; then
                            echo "   debian" #se já existe o start-ubuntu, mostra apenas o debian
                        elif $start_debian && $start_ubuntu; then
                            echo "$label_all_systems_have_been_installed"
                            #sed -i '\|elif $start_debian && $start_ubuntu; then|a echo "para atualizar"' $PREFIX/bin/andistro

                        else
                            echo "   debian"
                            echo "   ubuntu"
                    fi
                else
                # Não existe nenhum arquivo start-*
                echo "$label_andistro_there_no_system_installed"
                fi
                exit 1
            fi
        
            if [ "$2" == "debian" ]; then
                distro_name="debian"
                distro_version="stable"
            elif [ "$2" == "ubuntu" ]; then
                distro_name="ubuntu"
                distro_version="noble"
            else
                echo "$distro_command_not_found: $2"
                exit 1
            fi

            echo "$distro_wait"
            config_file="$andistro_files/boot/.config/$distro_name-based"
            bin="$andistro_files/boot/start-$distro_name"
            folder="$andistro_files/boot/$distro_name/stable"
            binds="$andistro_files/boot/$distro_name/binds"
            mkdir -p "$PREFIX/var/lib/andistro/boot/$distro_name"

            if [ ! -d "/sdcard/termux/andistro/boot/$distro_name/stable" ];then
                mkdir -p "/sdcard/termux/"
                mkdir -p "/sdcard/termux/andistro"
                mkdir -p "/sdcard/termux/andistro/boot"
                mkdir -p "/sdcard/termux/andistro/boot/$distro_name/stable"
            fi
            
            mkdir -p $binds
            andistro alerta timezone
            
            if [[ -n "${LANG_CODES[$system_icu_locale_code]}" ]]; then
                system_lang_code="$system_icu_locale_code"
            else
                system_lang_code="en-US"
            fi

            # Montar opções do menu
            OPTIONS=()
            OPTIONS+=("auto" "→ ${LANG_CODES[$system_lang_code]} $label_detected")
            OPTIONS+=("SEP" "────────────")  # Separador visual seguro

            # Adicionar os demais idiomas em ordem alfabética (exceto o detectado)
            for code in $(printf "%s\n" "${!LANG_CODES[@]}" | sort); do
                [[ "$code" == "$system_lang_code" ]] && continue
                OPTIONS+=("$code" "${LANG_CODES[$code]}")
            done

            # Tamanho da janela do dialog
            HEIGHT=0
            WIDTH=100
            CHOICE_HEIGHT=10

            # Mostrar menu com redirecionamento seguro
            exec 3>&1
            CHOICE=$(dialog --no-shadow --clear \
                --title "$label_choose_language" \
                --menu "$label_choose_language" \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                "${OPTIONS[@]}" \
                2>&1 1>&3)
                exec 3>&-

            # Determinar idioma selecionado
            if [[ "$CHOICE" == "auto" || -z "$CHOICE" ]]; then
                default_locale_system="$system_lang_code"
            elif [[ "$CHOICE" == "SEP" ]]; then
                exit 0  # ignorar separador
            else
                default_locale_system="$CHOICE"
            fi

            # Converter de pt-BR para pt_BR
            default_locale_env="${default_locale_system//-/_}"
            # Exportar, se necessário
            export default_locale_system
            export default_locale_env
            case `dpkg --print-architecture` in
                aarch64)
                    archurl="arm64" ;;
                arm)
                    archurl="armhf" ;;
                *)
                    echo "unknown architecture"; exit 1 ;;
            esac

            OPTIONS=(1 "${label_environments_select_default} (XFCE4)"
                    2 "${label_environments_select_light} (LXDE)"
                    3 "${label_environments_select_null}") 

            CHOICE=$(dialog --no-shadow --clear \
                        --title "$TITLE" \
                        --menu "$label_environments_select" \
                        $HEIGHT $WIDTH $CHOICE_HEIGHT \
                        "${OPTIONS[@]}" \
                        2>&1 >/dev/tty)
            case $CHOICE in
                1)	
                    # XFCE
                    config_environment="xfce4"
                
                    ;;
                2)	
                    # LXDE
                    config_environment="lxde"
                ;;
                3)
                    # Nenhum escolhido
                    rm -rf "$folder/root/system-config.sh"
                ;;
            esac
            OPTIONS=(1 "${label_light}"
                    2 "${label_dark}")

            CHOICE=$(dialog --no-shadow --clear \
                            --title "$TITLE" \
                            --menu "$label_choose_theme" \
                            $HEIGHT $WIDTH $CHOICE_HEIGHT \
                            "${OPTIONS[@]}" \
                            2>&1 >/dev/tty)
            case $CHOICE in
                1)	
                    distro_theme="Light"
                ;;
                2)	
                    distro_theme="Dark"
                ;;
            esac
            bash $PREFIX/var/lib/andistro/boot/install-$distro_name.sh "$config_file" "$andistro_files" "$distro_name" "$bin" "$folder" "$binds" "$default_locale_system" "$default_locale_env" "$archurl" "$config_environment" "$distro_theme" "$distro_version"
            clear
            andistro alerta install-success
            andistro -s $distro_name
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    -d)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if [ -z "$2" ]; then
                if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                    #Existe pelo menos um arquivo start-*
                    echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                    echo ""
                    echo "$distro_desc_line_2" #Exemplo de comando que permite a inicialização:
                    echo "$distro_desc_line_3" #andistro -s debian
                    echo " "
                    echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                    echo "$distro_desc_line_9" #   andistro -u
                    echo " "
                    echo "$distro_desc_line_10" #Comandos disponíveis para você:
                    echo "$distro_desc_line_11" #    -s  inicia a opção escolhida.
                    echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                    echo "   debian"
                    echo "   ubuntu"
                    echo " "
                    echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                    start_debian=false
                    start_ubuntu=false
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                        start_debian=true
                    fi
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                        start_ubuntu=true
                    fi
                    if $start_debian && ! $start_ubuntu; then
                        echo "   debian"
                    elif ! $start_debian && $start_ubuntu; then
                        echo "   ubuntu"
                    elif $start_debian && $start_ubuntu; then
                        echo "   debian"
                        echo "   ubuntu"
                    else
                        echo " "
                    fi
                    else
                        # Não existe nenhum arquivo start-*
                        echo "$label_andistro_there_no_system_installed"
                fi
                exit 1
            fi

            if [ "$2" == "total" ]; then
                # Desinstalação total
                echo "$distro_wait"
                rm -rf $andistro_files
                rm -rf $PREFIX/bin/andistro
                
                elif [ "$2" == "debian" ]; then
                    echo "$distro_wait"
                    distro_name="debian"

                elif [ "$2" == "ubuntu" ]; then
                    echo "$distro_wait"
                    distro_name="ubuntu"
                else
                    echo "$distro_command_not_found: $2"
                    exit 1
            fi
            rm -rf $andistro_files/boot/$distro_name
            rm -rf $andistro_files/boot/start-$distro_name
            andistro alerta uninstall-success
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    -s)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if [ -z "$2" ]; then
                if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                    #Existe pelo menos um arquivo start-*
                    echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                    echo ""
                    echo "$distro_desc_line_2" #Exemplo de comando que permite a inicialização:
                    echo "$distro_desc_line_3" #andistro -s debian
                    echo " "
                    echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                    echo "$distro_desc_line_9" #   andistro -u
                    echo " "
                    echo "$distro_desc_line_10" #Comandos disponíveis para você:
                    echo "$distro_desc_line_11" #    -s  inicia a opção escolhida.
                    echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                    echo "   debian"
                    echo "   ubuntu"
                    echo " "
                    echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                    start_debian=false
                    start_ubuntu=false
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                        start_debian=true
                    fi
                    if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                        start_ubuntu=true
                    fi
                    if $start_debian && ! $start_ubuntu; then
                        echo "   debian"
                    elif ! $start_debian && $start_ubuntu; then
                        echo "   ubuntu"
                    elif $start_debian && $start_ubuntu; then
                        echo "   debian"
                        echo "   ubuntu"
                    else
                        echo " "
                    fi
                else
                # Não existe nenhum arquivo start-*
                echo "$label_andistro_there_no_system_installed"
                fi
            fi

            if [ "$2" == "debian" ]; then
                echo "$distro_wait"
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                bash $PREFIX/var/lib/andistro/boot/start-debian
                else
                echo "O Desbian ainda não foi instalado, siga os passos abaixo para a instalação:\n
                Digite o comando 'andistro' seguido do enter , escolha a opção instalar,"
                fi

            elif [ "$2" == "ubuntu" ]; then
                echo "$distro_wait"
                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                bash $PREFIX/var/lib/andistro/boot/start-ubuntu
                else
                echo "O arquivo não existe"
                fi
                

            else
                echo "$distro_command_not_found: $2"
                exit 1
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;

    -t|terminal)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            if ls "$PREFIX/var/lib/andistro/boot/start-"* 1>/dev/null 2>&1; then
                echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                echo ""
                echo "$distro_desc_line_2" #Exemplo de comando que permite a inicialização:
                echo "$distro_desc_line_3" #andistro -s debian
                echo " "
                echo "$distro_desc_line_4" #Exemplo de comando que permite a desinstalação:
                echo "$distro_desc_line_5" #   andistro -d debian
                echo " "
                echo "$distro_desc_line_6" #Exemplo de comando que permite a instalação:
                echo "$distro_desc_line_7" #   andistro -i debian
                echo " "
                echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                echo "$distro_desc_line_9" #   andistro -u
                echo " "
                echo "$distro_desc_line_10" #Comandos disponíveis para você:
                echo "$distro_desc_line_11" #    -s  inicia a opção escolhida.
                echo "$distro_desc_line_12" #    -d  desinstala a opção escolhida.
                echo "$distro_desc_line_13" #    -i  instala a opção escolhida.
                echo "$distro_desc_line_14" #    -u  atualiza o AnDistro.
                echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                echo "   debian"
                echo "   ubuntu"
                echo " "
                echo "$distro_desc_line_16" #Opções de sistemas disponíveis para a inicialização e desinstalação:
                start_debian=false
                start_ubuntu=false
                if [ -f "$PREFIX/var/lib/andistro/boot/start-debian" ]; then
                    start_debian=true
                fi
                if [ -f "$PREFIX/var/lib/andistro/boot/start-ubuntu" ]; then
                    start_ubuntu=true
                fi
                if $start_debian && ! $start_ubuntu; then
                    echo "   debian"
                elif ! $start_debian && $start_ubuntu; then
                    echo "   ubuntu"
                elif $start_debian && $start_ubuntu; then
                    echo "   debian"
                    echo "   ubuntu"
                else
                    echo " "
                fi
                echo " "
            else
                echo "$distro_desc_line_1" #Use: andistro <comando> <opção> para seja feito a tarefa desejada.
                echo ""
                echo "$distro_desc_line_6" #Exemplo de comando que permite a instalação:
                echo "$distro_desc_line_7" #   andistro -i debian
                echo " "
                echo "$distro_desc_line_8" #Exemplo de comando que permite a atualização do AnDistro:
                echo "$distro_desc_line_9" #   andistro -u
                echo " "
                echo "$distro_desc_line_10" #Comandos disponíveis para você:
                echo "$distro_desc_line_13" #    -i  instala a opção escolhida.
                echo "$distro_desc_line_14" #    -u  atualiza o AnDistro.
                echo " "
                echo "$distro_desc_line_15" #Opções de sistemas disponíveis para a instalação:
                echo "   debian"
                echo "   ubuntu"
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    --setup)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                echo "$distro_command_not_found: $2"
            else
                case "$2" in
                    storage)
                        if [ -d "/sdcard" ]; then
                            if ls "/sdcard" &>/dev/null; then
                                # Acesso ao armazenamento OK!
                                echo "Acesso ao armazenamento."
                            else
                                # A pasta existe, mas sem permissão de acesso.
                                dialog --no-shadow --title "Permissão necessária" --ok-label "Permitir" \
                            --msgbox "Sem permissão de acesso." 8 50
                            rm -rf storage
                            termux-setup-storage
                            fi
                        else
                            termux-setup-storage
                        fi
                        ;;
                    battery)
                        dialog --no-shadow --title "Permissão necessária" --ok-label "Permitir" \
                            --msgbox "Após clicar em permitir, procure pelo Termux na lista de aplicativos, clique e escolha a opção não restrito." 8 50
                        am start -a android.settings.IGNORE_BATTERY_OPTIMIZATION_SETTINGS
                        ;;
                    termux-details-settings)
                        dialog --no-shadow --title "Informação" \
                            --msgbox "Após clicar em \"Ok\" será aberto a as informações do Termux no sistema." 8 50
                        am start -a android.settings.APPLICATION_DETAILS_SETTINGS -d "package:com.termux"
                        ;;
    
                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    --set-edit)
        if echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            # Comando interno para iniciar a edição direta do código
            if [ -z "$2" ]; then
                # Não foi passado subcomando, comportamento padrão
                nano "$PREFIX/bin/andistro"
            else
                case "$2" in
                    install-debian)
                        nano "$PREFIX/var/lib/andistro/boot/install-debian.sh"
                        ;;
                    start-debian)
                        nano "$PREFIX/var/lib/andistro/boot/start-debian"
                        ;;
                    install-ubuntu)
                        nano "$PREFIX/var/lib/andistro/boot/install-ubuntu.sh"
                        ;;
                    start-ubuntu)
                        nano "$PREFIX/var/lib/andistro/boot/start-ubuntu"
                        ;;
                    module-global)
                        nano "$PREFIX/var/lib/andistro/lib/share/global"
                        ;;
                    module-locale)
                        nano "$PREFIX/var/lib/andistro/lib/share/locales_${system_icu_locale_code}.sh"
                        ;;
                    *)
                        echo "$distro_command_not_found: $2"
                        ;;
                esac
            fi
        elif echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            echo "$label_command_problem_andistro_for_distro"
        else
            echo "$label_system_not_found"
        fi
        ;;
    alerta)
        if [ -z "$2" ]; then
            # Não foi passado subcomando, comportamento padrão
            echo "$distro_command_not_found"
        else
            case "$2" in
                timezone)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "${label_distro_alert_timezone_desc} \n$label_distro_alert_timezone_detected $system_timezone\n\n$label_sleep_in_10s" 10 60 0
                    ;;
                install-success)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "${label_install_success} \n\n$label_sleep_in_10s" 10 60 0
                    ;;
                uninstall-success)
                    {
                        for i in {1..50}; do
                            sleep 0.1
                            echo $((i * 2))
                        done
                    } | dialog --no-shadow --gauge "${label_uninstall_success} \n\n$label_sleep_in_10s" 10 60 0
                    ;;
                *)
                    echo "$distro_command_not_found: $2"
                    ;;
            esac
        fi
        ;;
    --boot)
        if echo "$inxi_out" | grep -Eq 'Distro:.*(Debian|Ubuntu)'; then
            shift
            if [[ "$1" == "vnc" ]]; then
                shift 
                DISPLAY_VALUE=""
                PORT_VALUE=""
                SCALE_VALUE=""

                while [[ $# -gt 0 ]]; do
                    case "$1" in
                        --display)
                            DISPLAY_VALUE="$2"
                            #echo "Display set to $DISPLAY_VALUE"
                            shift 2
                            ;;
                        --scale)
                            SCALE_VALUE="$2"
                            #echo "Scale set to $SCALE_VALUE"
                            shift 2
                            ;;
                        --port)
                            PORT_VALUE="$2"
                            #echo "Port set to $PORT_VALUE"
                            shift 2
                            ;;
                        --kill)
                            # Buscar arquivos PID relacionados ao usuário
                            PID_FILES=$(ls -1 ~/.vnc/localhost:* 2>/dev/null)

                            # Verificar se há servidores ativos
                            if [ -z "$PID_FILES" ]; then
                                echo "$label_server_kill_desc_error"
                                exit 1
                            fi
                            # Extrair a porta do primeiro arquivo encontrado (ex: localhost:1.pid → 1)
                            PORTA=$(echo "$PID_FILES" | head -n1 | cut -d':' -f2 | cut -d'.' -f1)
                            echo "$label_server_kill_desc"
                            echo "$label_server_kill_desced: $PORTA"
                            # Parar o servidor VNC
                            vncserver -kill :$PORTA
                            # Remover arquivos temporários
                            rm -rf /tmp/.X$PORTA-lock
                            rm -rf /tmp/.X*-lock
                            rm -rf /tmp/.X11-unix/X$PORTA
                            rm -rf /tmp/.X11-unix/X*
                            shift
                            exit 1
                            ;;
                        --passwd)
                            while true; do # Loop até obter uma senha válida ou o usuário cancelar
                            PASSWORD=$(dialog --no-shadow --insecure --passwordbox "$label_password_input" 10 50 3>&1 1>&2 2>&3)
                            if [ $? -eq 0 ]; then
                                # Valida senha não vazia
                                if [ -z "$PASSWORD" ]; then
                                    dialog --no-shadow --title "$label_error" --msgbox "$label_password_input_alert_important" 10 50
                                    continue
                                fi
                                break
                            else
                                echo "${label_entry_canceled}"
                                exit 1
                            fi

                            done

                            # Salvar a senha no arquivo apropriado
                            if ! /usr/bin/vncpasswd -f <<<"$PASSWORD"$'\n'"$PASSWORD" > "$HOME/.vnc/passwd"; then
                                dialog --no-shadow --title "$label_error" --msgbox "$label_password_save_failed" 10 50
                                exit 1
                            fi

                            # Proteger o arquivo com permissão segura
                            chmod 600 "$HOME/.vnc/passwd"

                            # Barra de progresso
                            {
                                for ((i = 0; i <= 100; i+=2)); do
                                    sleep 0.08
                                    echo $i
                                done
                            } | dialog --no-shadow --gauge "${label_change_password}" 10 50
                            shift
                            exit 1
                            ;;
                        *)
                            echo "Comando ou parâmetro desconhecido: $1"
                            shift
                        ;;
                    esac
                done
                # Validar se a porta foi fornecida
                if [[ -z "$PORT_VALUE" ]]; then
                    echo "Erro: --port é obrigatório."
                    exit 1
                fi
                if [[ -n "$DISPLAY_VALUE" ]]; then
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop $DISPLAY_VALUE :$PORT_VALUE"
                    vncserver -localhost no -depth 24 -name remote-desktop -geometry "$DISPLAY_VALUE" :$PORT_VALUE
                    #vncserver -localhost no -depth 24 -name remote-desktop -geometry "1920x1080" :1
                else
                    #echo "Executando: vncserver -localhost -no -depth 24 -name remote-desktop :$PORT_VALUE"
                    vncserver -localhost no -depth 24 -name remote-desktop :"$PORT_VALUE"
                    #vncserver -localhost no -depth 24 -name remote-desktop :1
                fi

                # Verifica se o vncserver está rodando
                if pgrep -x "Xtigervnc" > /dev/null; then
                    # Se xfce4-session estiver rodando executa o comando de escala
                    if pgrep -x "xfce4-session" > /dev/null && [ -n "$SCALE_VALUE" ]; then
                        xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s "$SCALE_VALUE"
                    fi

                    echo -e "\n${label_server_start_desc} $USER\n\n${label_localhost} $HOSTNAME:$PORT / 120.0.0.1:$PORT / $WLAN_IP:$PORT\n\n$label_password_forgot\n"
                else
                    echo "$label_server_start_error"
                fi
            fi
        elif echo "$inxi_out" | grep -q 'Distro:.*Android'; then
            echo "$label_command_not_available"
        else
            echo "$label_system_not_found"  
        fi
        ;;

    *)
        echo "$distro_command_not_found $1"
        exit 1
        ;;
esac        

#!/bin/bash
if ! dpkg -l | grep -qw dialog; then
    timestamp=$(date +'%d%m%Y-%H%M%S')
    apt install dialog -y >> "/sdcard/termux/andistro/logs/${distro_name}_startvncserver_dialog_${timestamp}.txt" 2>&1
fi

# Para qualquer inicialização anterior
stopvnc

source "/usr/local/lib/andistro/global"

HEIGHT=0
WIDTH=0
CHOICE_HEIGHT=5
BACKTITLE="${label_vncserver_resolution_title}"
TITLE="startvncserver"
MENU="${label_vncserver_resolution_option}"
export PORT=1

# Identificador de resolução repetida - Início
RESOLUTION_LOG="/root/.server_resolution_history"

# Criar arquivo de log se não existir
if [[ ! -f "$RESOLUTION_LOG" ]]; then
    touch "$RESOLUTION_LOG"
fi

# Função para salvar resolução no histórico
save_resolution() {
    local res="$1"
    echo "$res|$(date +%s)" >> "$RESOLUTION_LOG"
}

# Função para verificar resoluções repetidas
check_repeated_resolution() {
    local current_res="$1"
    local count=0
    local recent_count=0
    local time_threshold=$(($(date +%s) - 604800)) # últimos 7 dias
    
    while IFS='|' read -r res timestamp; do
        if [[ "$res" == "$current_res" ]]; then
            ((count++))
            if [[ $timestamp -ge $time_threshold ]]; then
                ((recent_count++))
            fi
        fi
    done < "$RESOLUTION_LOG"
    
    # Se foi usado 3+ vezes no total ou 2+ vezes na última semana
    if [[ $count -ge 3 ]] || [[ $recent_count -ge 2 ]]; then
        return 0 # resolução repetida detectada
    else
        return 1 # não é repetida o suficiente
    fi
}

# Função para perguntar se quer definir como padrão
ask_set_default() {
    local res="$1"
    desc_expandido=$(eval echo "$label_vncserver_resolution_frequent_desc" | sed "s/%s/$res/")
    dialog --no-shadow --backtitle "$label_vnc_setup" \
           --title "$label_vncserver_resolution_frequent_desc_title" \
           --yesno "$desc_expandido" 10 60
    return $?
}

# Função para salvar resolução padrão
save_default_resolution() {
    local res="$1"
    local port="$2"
    local scale="$3"
    echo "RESOLUTION=$res" > /root/.vnc_default
    echo "PORT=$port" >> /root/.vnc_default
    echo "SCALE=$scale" >> /root/.vnc_default
}

# Verificar se existe resolução padrão
if [[ -f /root/.vnc_default ]]; then
    source /root/.vnc_default
    if [[ -n "$RESOLUTION" ]]; then
        dialog --no-shadow --backtitle "$label_vnc_setup" \
               --title "$label_vncserver_resolution_default" \
               --yesno "$label_vncserver_resolution_default_desc" 10 60
        if [[ $? -eq 0 ]]; then
            echo "$label_vncserver_chose_resolution_default: $RESOLUTION"
            if [[ "$RESOLUTION" =~ ^([0-9]+)x([0-9]+)$ ]]; then
                GEO="-geometry $RESOLUTION" PORT=${PORT:-1} ESCALA=${SCALE:-1} vnc
                bash --login
                exit 0
            fi
        else
            # Usuário optou por não usar o padrão - perguntar se quer remover
            dialog --no-shadow --backtitle "$label_vnc_setup" \
                   --title "$label_vncserver_remove_default_title" \
                   --yesno "$label_vncserver_remove_default_desc" 10 60
            if [[ $? -eq 0 ]]; then
                rm -f /root/.vnc_default
                dialog --no-shadow --msgbox "$label_vncserver_remove_default_sucess" 6 40
            fi
        fi
    fi
fi
# Identificador de resolução repetida - Fim


OPTIONS=(1 "${label_vncserver_resolution_option_custom}"
         2 "${label_vncserver_resolution_option_predefined}")

CHOICE=$(dialog --no-shadow --no-shadow --clear \
                --backtitle "$BACKTITLE" \
                --title "$TITLE" \
                --menu "$MENU" \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                "${OPTIONS[@]}" \
                2>&1 >/dev/tty)
clear
case $CHOICE in
1)
    set +H
    largura_default=""; altura_default=""; escala_default="1"; porta_default="1"
    tentou=""
    foi_confirmado=0

    while true; do
        dialog_msgbox="$label_vncserver_chose_resolution_custom\n$label_vncserver_chose_resolution_custom_desc\n$label_vncserver_chose_resolution_custom_desc_port\n$label_vncserver_chose_resolution_custom_alert\n$label_vncserver_chose_resolution_custom_alert_caption\n\n"
        mensagem_erro=""

        # Checa se já houve tentativa e há campos problemáticos
        if [[ -n "$tentou" ]]; then
            falta_msg=""
            [[ -z "$largura_default"  || ! "$largura_default"  =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_width} ${label_numbers_only}\n"
            [[ -z "$altura_default"   || ! "$altura_default"   =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_height} ${label_numbers_only}\n"
            [[ -z "$escala_default"   || ! "$escala_default"   =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_scale} ${label_numbers_only}\n"
            [[ -z "$porta_default"    || ! "$porta_default"    =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_port} ${label_numbers_only}\n"
            [[ -n "$falta_msg" ]] && mensagem_erro="${label_vncserver_chose_resolution_custom_alert_error}:\n$falta_msg"
        fi

        cabecalho="$label_vnc_setup"
        if [[ -n "$mensagem_erro" ]]; then
            titulo="$dialog_msgbox\n----------------\n$mensagem_erro\n\n${label_numbers_only}"
        else
            titulo="$dialog_msgbox\n${label_numbers_only}"
        fi
        exec 3>&1
        result=$(dialog --no-shadow --ok-label "${label_confirm}" --cancel-label "${label_cancel}" --backtitle "$cabecalho" \
            --form "$titulo" \
            0 0 4 \
            "${label_width}:" 1 1 "$largura_default" 1 20 10 0 \
            "${label_height}:"  2 1 "$altura_default"  2 20 10 0 \
            "${label_scale}:"  3 1 "$escala_default"  3 20 10 0 \
            "${label_port}:"   4 1 "$porta_default"   4 20 10 0 \
            2>&1 1>&3)
        dialog_exit_status=$?
        exec 3>&-

        if [[ $dialog_exit_status -eq 1 || $dialog_exit_status -eq 255 || -z "$result" ]]; then
            echo "$label_vncserver_chose_resolution_canceled"
            clear
            startvnc
            break
        fi

        tentou=1
        largura_default="$(echo "$result" | sed -n 1p)"
        altura_default="$(echo "$result" | sed -n 2p)"
        escala_default="$(echo "$result" | sed -n 3p)"
        porta_default="$(echo "$result" | sed -n 4p)"

        if [[ "$largura_default" =~ ^[0-9]+$ ]] &&
        [[ "$altura_default"  =~ ^[0-9]+$ ]] &&
        [[ "$escala_default"  =~ ^[0-9]+$ ]] &&
        [[ "$porta_default"   =~ ^[0-9]+$ ]]; then
            foi_confirmado=1
            break
        fi
    done
    set -H

    # Só mostra se foi confirmado
    if [[ $foi_confirmado -eq 1 ]]; then
        echo "$label_vncserver_chose_resolution_default: ${largura_default}x${altura_default}, $label_scale: ${escala_default}, $label_port: ${porta_default}"
        
        # Verificar se é resolução repetida e perguntar sobre padrão
        current_resolution="${largura_default}x${altura_default}"
        save_resolution "$current_resolution"
        
        if check_repeated_resolution "$current_resolution"; then
            if ask_set_default "$current_resolution"; then
                save_default_resolution "$current_resolution" "$porta_default" "$escala_default"
                echo "$label_vncserver_chose_resolution_custom ($current_resolution)" 6 50
            fi
        fi
    fi

    GEO="-geometry ${largura_default}x${altura_default}" PORT=$porta_default  ESCALA=$escala_default vnc
;;
2)
    OPTIONS=(1 "Horizontal"
             2 "Vertical")
    CHOICE=$(dialog --no-shadow --no-shadow --clear \
                --backtitle "$BACKTITLE" \
                --title "$TITLE" \
                --menu "$MENU" \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                "${OPTIONS[@]}" \
                2>&1 >/dev/tty)
                clear
    case $CHOICE in
    1)
        MENU="${label_vncserver_resolution_option_horizontal}"
        OPTIONS=(1 "${label_vncserver_resolution_option_uwhd}"
                 2 "${label_vncserver_resolution_option_qdhd}"
                 3 "${label_vncserver_resolution_option_fhd}"
                 4 "${label_vncserver_resolution_option_hd}")

        CHOICE=$(dialog --no-shadow --no-shadow --clear \
                        --backtitle "$BACKTITLE" \
                        --title "$TITLE" \
                        --menu "$MENU" \
                        $HEIGHT $WIDTH $CHOICE_HEIGHT \
                        "${OPTIONS[@]}" \
                        2>&1 >/dev/tty)

        clear
        case $CHOICE in
        1)
            echo "${label_vncserver_chose_resolution_uwhd}"
            current_resolution="2560x1080"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_uwhd ($current_resolution)" 6 50
                fi
            fi
            
            GEO="-geometry 2560x1080" vnc
        ;;
        2)
            echo "${label_vncserver_chose_resolution_qdhd}"
            current_resolution="2560x1440"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_qdhd ($current_resolution)" 6 50
                fi
            fi
            
            GEO="-geometry 2560x1440" vnc
        ;;
        3)
            echo "${label_vncserver_chose_resolution_fhd}"
            current_resolution="1920x1080"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_fhd ($current_resolution)" 6 50
                fi
            fi
            
            GEO="-geometry 1920x1080" vnc
        ;;
        4)
            echo "${label_vncserver_chose_resolution_hd}"
            current_resolution="1280x720"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_hd ($current_resolution)" 6 50
                fi
            fi
            
            GEO="-geometry 1280x720" vnc
        ;;
    2)
        MENU="${label_vncserver_resolution_option_vertical}"
        OPTIONS=(1 "${label_vncserver_resolution_option_qdhd}"
                 2 "${label_vncserver_resolution_option_qdhdplus}"
                 3 "${label_vncserver_resolution_option_fhd}"
                 4 "${label_vncserver_resolution_option_fhdplus}"
                 5 "${label_vncserver_resolution_option_hd}"
                 6 "${label_vncserver_resolution_option_hdplus}")

        CHOICE=$(dialog --no-shadow --no-shadow --clear \
                        --backtitle "$BACKTITLE" \
                        --title "$TITLE" \
                        --menu "$MENU" \
                        $HEIGHT $WIDTH $CHOICE_HEIGHT \
                        "${OPTIONS[@]}" \
                        2>&1 >/dev/tty)

        clear
        case $CHOICE in
        1)
            echo "${label_vncserver_chose_resolution_qdhd}"
            current_resolution="1440x2560"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_qdhd ($current_resolution)" 6 50
                fi
            fi
            GEO="-geometry $current_resolution" vnc
        ;;
        2)
            echo "${label_vncserver_chose_resolution_qdhdplus}"
            current_resolution="1440x3120"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_qdhdplus ($current_resolution)" 6 50
                fi
            fi
            GEO="-geometry $current_resolution" vnc
        ;;
        3)
            echo "${label_vncserver_chose_resolution_fhd}"
            current_resolution="1080x1920"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_fhd ($current_resolution)" 6 50
                fi
            fi

            GEO="-geometry $current_resolution" vnc
        ;;
        4)
            echo "${label_vncserver_chose_resolution_fhdplus}"
            current_resolution="1080x2340"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_fhdplus ($current_resolution)" 6 50
                fi
            fi

            GEO="-geometry $current_resolution" vnc
        ;;
        5)
            echo "${label_vncserver_chose_resolution_hd}"
            current_resolution="720x1280"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_hd ($current_resolution)" 6 50
                fi
            fi

            GEO="-geometry $current_resolution" vnc
        ;;
        6)
            echo "${label_vncserver_chose_resolution_hdplus}"
            current_resolution="720x1560"
            save_resolution "$current_resolution"
            
            if check_repeated_resolution "$current_resolution"; then
                if ask_set_default "$current_resolution"; then
                    save_default_resolution "$current_resolution" "1" "1"
                    echo "$label_vncserver_chose_resolution_hdplus ($current_resolution)" 6 50
                fi
            fi

            GEO="-geometry $current_resolution" vnc
        ;;
    esac
    ;;
esac
bash --login

source "/usr/local/bin/global_var_fun.sh"

while true; do
    dialog --msgbox "Toque no botão para abrir o teclado (⌨). Caso não faça isso, a próxima etapa terá erro. Depois pressione OK." 0 0
    msgbox_status=$?

    if [ "$msgbox_status" -eq 0 ]; then
        PASSWORD=$(dialog --title "oi" --insecure --passwordbox "teste amigo" 0 0 3>&1 1>&2 2>&3)
        if [ $? -eq 0 ]; then
            break
        else
            echo "${label_entry_canceled}"
            exit 1
        fi
    else
        clear
        echo "Tentando novamente... (status=$msgbox_status)"
        sleep 0.5
    fi
done

# Salvar a senha no arquivo apropriado
if ! /usr/bin/vncpasswd -f <<<"$PASSWORD"$'\n'"$PASSWORD" > "$HOME/.vnc/passwd"; then
    dialog --title "Erro" --msgbox "Falha ao salvar a senha!" 0 0
    exit 1
fi

# Proteger o arquivo com permissão segura
chmod 600 "$HOME/.vnc/passwd"

# Barra de progresso
{
    for ((i = 0; i <= 100; i+=2)); do
        sleep 0.08
        echo $i
    done
} | dialog --gauge "${label_change_password}" 6 50 0

clear

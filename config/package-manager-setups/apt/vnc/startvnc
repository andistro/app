#!/bin/bash
timestamp=$(date +'%d%m%Y-%H%M%S')
LOGFILE="/sdcard/termux/andistro/logs/startvnc_${timestamp}.txt"
exec > >(tee -a "$LOGFILE") 2>&1


source "/usr/local/bin/global_var_fun.sh"
if ! dpkg -l | grep -qw dialog; then
    apt install dialog -y >> "/sdcard/termux/andistro/logs/${distro_name}_dialog_${timestamp}.txt" 2>&1
fi

# Para qualquer inicialização anterior
stopvnc

HEIGHT=0
WIDTH=0
CHOICE_HEIGHT=5
BACKTITLE="${label_vncserver_resolution_title}"
TITLE="startvncserver"
MENU="${label_vncserver_resolution_option}"
export PORT=1


OPTIONS=(1 "${label_vncserver_resolution_option_custom}"
         2 "${label_vncserver_resolution_option_uwhd}"
         3 "${label_vncserver_resolution_option_qdhd}"
         4 "${label_vncserver_resolution_option_fhd}"
         5 "${label_vncserver_resolution_option_hd}")



CHOICE=$(dialog --no-shadow --clear \
                --backtitle "$BACKTITLE" \
                --title "$TITLE" \
                --menu "$MENU" \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                "${OPTIONS[@]}" \
                2>&1 >/dev/tty)

clear
case $CHOICE in
1)
    set +H
    largura_default=""; altura_default=""; escala_default="1"; porta_default="1"
    tentou=""
    foi_confirmado=0

    while true; do
        dialog_msgbox="$label_vncserver_chose_resolution_custom\n$label_vncserver_chose_resolution_custom_desc\n$label_vncserver_chose_resolution_custom_desc_port\n$label_vncserver_chose_resolution_custom_alert\n$label_vncserver_chose_resolution_custom_alert_caption\n\n"
        mensagem_erro=""

        # Checa se já houve tentativa e há campos problemáticos
        if [[ -n "$tentou" ]]; then
            falta_msg=""
            [[ -z "$largura_default"  || ! "$largura_default"  =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_width} ${label_numbers_only}\n"
            [[ -z "$altura_default"   || ! "$altura_default"   =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_height} ${label_numbers_only}\n"
            [[ -z "$escala_default"   || ! "$escala_default"   =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_scale} ${label_numbers_only}\n"
            [[ -z "$porta_default"    || ! "$porta_default"    =~ ^[0-9]+$ ]] && falta_msg="${falta_msg}${label_port} ${label_numbers_only}\n"
            [[ -n "$falta_msg" ]] && mensagem_erro="${label_vncserver_chose_resolution_custom_alert_error}:\n$falta_msg"
        fi

        cabecalho="Configuração do VNC Server"
        if [[ -n "$mensagem_erro" ]]; then
            titulo="$dialog_msgbox\n----------------\n$mensagem_erro\n\n${label_numbers_only}"
        else
            titulo="$dialog_msgbox\n${label_numbers_only}"
        fi
        exec 3>&1
        result=$(dialog --no-shadow --ok-label "${label_confirm}" --cancel-label "${label_cancel}" --backtitle "$cabecalho" \
            --form "$titulo" \
            0 0 4 \
            "${label_width}:" 1 1 "$largura_default" 1 20 10 0 \
            "${label_height}:"  2 1 "$altura_default"  2 20 10 0 \
            "${label_scale}:"  3 1 "$escala_default"  3 20 10 0 \
            "${label_port}:"   4 1 "$porta_default"   4 20 10 0 \
            2>&1 1>&3)
        dialog_exit_status=$?
        exec 3>&-

        if [[ $dialog_exit_status -eq 1 || $dialog_exit_status -eq 255 || -z "$result" ]]; then
            echo "Cancelado. Use o comando startvnc para selecionar outra resolução"
            clear
            startvnc
            break
        fi

        tentou=1
        largura_default="$(echo "$result" | sed -n 1p)"
        altura_default="$(echo "$result" | sed -n 2p)"
        escala_default="$(echo "$result" | sed -n 3p)"
        porta_default="$(echo "$result" | sed -n 4p)"

        if [[ "$largura_default" =~ ^[0-9]+$ ]] &&
        [[ "$altura_default"  =~ ^[0-9]+$ ]] &&
        [[ "$escala_default"  =~ ^[0-9]+$ ]] &&
        [[ "$porta_default"   =~ ^[0-9]+$ ]]; then
            foi_confirmado=1
            break
        fi
    done
    set -H

    # Só mostra se foi confirmado
    if [[ $foi_confirmado -eq 1 ]]; then
        echo "Resolução definida: ${largura_default}x${altura_default}, Escala: ${escala_default}, Porta: ${porta_default}"
    fi
    GEO="-geometry ${largura_default}x${altura_default}" PORT=$porta_default vnc
    xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s $escala_default
;;
2)
    echo "${label_vncserver_chose_resolution_uwhd}"
    GEO="-geometry 2560x1080" vnc
    xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s 1
;;
3)
    echo "${label_vncserver_chose_resolution_qdhd}"
    GEO="-geometry 2560x1440" vnc
    xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s 1
;;
4)
    echo "${label_vncserver_chose_resolution_fhd}"
    GEO="-geometry 1920x1080" vnc
    xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s 1
;;
5)
    echo "${label_vncserver_chose_resolution_hd}"
    GEO="-geometry 1280x720" vnc
    xfconf-query -c xsettings -p /Gdk/WindowScalingFactor -s 1
;;

esac
